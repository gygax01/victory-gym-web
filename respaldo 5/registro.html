<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro de Cliente</title>
  <link rel="stylesheet" href="css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<header class="header-brand">
  <div class="brand">
    <img src="img/logo.png">
    <h2>Registro de Cliente</h2>
  </div>
  <button onclick="location.href='login.html'">← Volver</button>
</header>

<div class="card registro-pc">
  <input id="inputNombre" placeholder="Nombre completo">
  <input id="inputTelefono" placeholder="Teléfono">

  <button id="btnAsignar">Asignar tarjeta</button>
  <button id="btnFinalizar" disabled>Registrar cliente</button>
</div>

<div class="overlay" id="overlay" style="display:none">
  <div class="popup">
    <div id="estadoNFC">Esperando tarjeta…</div>
  </div>
</div>

<script src="js/storage.js"></script>
<script src="js/auth.js"></script>
<script src="js/nfc.js"></script>

<script>
if (!verificarSesion()) return;
if (!requirePermission("clients_create")) return;

let tarjetaUID = null;

btnAsignar.onclick = () => {
  overlay.style.display = "flex";
  iniciarNFCControlado({
    onUID: uid => {
      if (uidYaRegistrada(uid)) {
        estadoNFC.textContent = "Tarjeta ya registrada";
        setTimeout(() => overlay.style.display = "none", 1500);
        return;
      }
      tarjetaUID = uid;
      btnFinalizar.disabled = false;
      overlay.style.display = "none";
      detenerNFC();
    }
  });
};

btnFinalizar.onclick = () => {
  const clientes = obtenerClientes();
  clientes.push({
    nombre: inputNombre.value.trim(),
    telefono: inputTelefono.value.trim(),
    tarjetaUID,
    fechaRegistro: hoy()
  });
  guardarClientes(clientes);
  location.href = "index.html";
};
</script>

</body>
</html>
