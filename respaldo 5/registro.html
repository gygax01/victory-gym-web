<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Cliente</title>
  <link rel="stylesheet" href="css/styles.css">

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ===== ADAPTACIÓN SOLO TAMAÑO MÓVIL ===== -->
  <style>
  @media (max-width: 768px){

    .header-brand{
      flex-direction: column;
      gap: 14px;
      padding: 18px;
      text-align:center;
    }

    .brand{
      flex-direction: column;
      gap: 8px;
    }

    .brand img{
      height: 70px;
    }

    .brand h2{
      font-size: 20px;
    }

    header button{
      width: 100%;
      margin-left: 0;
    }

    .card.registro-pc{
      grid-template-columns: 1fr !important;
      padding: 28px 20px;
      gap: 24px;
    }

    .registro-col h3{
      text-align:center;
    }

    .registro-col input{
      height: 48px;
      font-size: 15px;
    }

    .membresias-grid{
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .membresias-grid button{
      padding: 14px;
      font-size: 14px;
    }

    .registro-acciones{
      flex-direction: column;
      gap: 12px;
    }

    .registro-acciones button{
      width: 100%;
      height: 46px;
      font-size: 15px;
    }

    .popup{
      width: 92%;
      padding: 30px 20px;
    }

    .confirmacion .box{
      width: 92%;
      padding: 40px 20px;
    }

  }
  </style>
</head>

<body onload="verificarSesion()">

<header class="header-brand">
  <div class="brand">
    <img src="img/logo.png">
    <h2>Registro de Cliente</h2>
  </div>

  <button class="btn-volver" onclick="location.href='index.html'">
    ← Inicio
  </button>
</header>

<main class="main">
  <div class="card registro-pc">

    <!-- COLUMNA IZQUIERDA -->
    <div class="registro-col">
      <h3>Datos del cliente</h3>

      <input id="nombre" placeholder="Nombre completo">
      <input id="peso" type="number" step="0.1" placeholder="Peso (kg)">
      <input id="altura" type="number" step="0.01" placeholder="Altura (m)">
      <input id="telefono" type="tel" placeholder="Teléfono">
    </div>

    <!-- COLUMNA DERECHA -->
    <div class="registro-col">
      <h3>Membresía</h3>

      <div class="membresias-grid">
        <button onclick="setDias(7)">7 días</button>
        <button onclick="setDias(15)">15 días</button>
        <button onclick="setDias(30)">1 mes</button>
        <button onclick="setDias(90)">3 meses</button>
      </div>

      <p id="expiraTexto"></p>

      <div class="registro-acciones">
        <button class="nfc" onclick="abrirPopup()">Asignar tarjeta</button>
        <button id="finalizar" onclick="registrarCliente()" disabled>
          Registrar cliente
        </button>
      </div>
    </div>

  </div>
</main>

<!-- NFC -->
<div class="overlay" id="overlay">
  <div class="popup">
    <h2>Acerque la tarjeta</h2>
    <div id="estado" class="estado amarillo">Esperando tarjeta…</div>
    <div id="uidTexto" class="uid"></div>
  </div>
</div>

<!-- CONFIRM -->
<div class="confirmacion" id="confirmacion">
  <div class="box">
    <h1 id="tituloConfirm"></h1>
    <p id="mensajeConfirm"></p>
  </div>
</div>

<!-- CORE -->
<script src="js/storage.js"></script>
<script src="js/auth.js"></script>

<!-- CREA window.supabaseClient + funciones clientes -->
<script src="js/realtime.js"></script>

<!-- NFC -->
<script src="js/nfc.js"></script>

<script>
let tarjetaUID = null;
let diasMembresia = 0;
let leyendoNFC = false;

/* ===== MEMBRESÍA ===== */
function setDias(d) {
  diasMembresia = d;
  const expira = new Date();
  expira.setDate(expira.getDate() + d);
  expiraTexto.innerText =
    "Expira el: " + expira.toLocaleDateString();
}

/* ===== NFC ===== */
function abrirPopup() {
  if (leyendoNFC) return;

  tarjetaUID = null;
  leyendoNFC = true;
  finalizar.disabled = true;

  overlay.style.display = "flex";
  estado.className = "estado amarillo";
  estado.innerText = "Esperando tarjeta…";
  uidTexto.innerText = "";

  iniciarNFCControlado({
    onUID: uid => {
      if (uidYaRegistrada(uid)) {
        estado.className = "estado rojo";
        estado.innerText = "Tarjeta ya registrada";
        uidTexto.innerText = "UID: " + uid;
        setTimeout(cerrarPopup, 1500);
        return;
      }

      tarjetaUID = uid;
      estado.className = "estado verde";
      estado.innerText = "Tarjeta asignada";
      uidTexto.innerText = "UID: " + uid;

      setTimeout(() => {
        cerrarPopup();
        finalizar.disabled = false;
      }, 1200);
    }
  });
}

function cerrarPopup() {
  overlay.style.display = "none";
  detenerNFC();
  leyendoNFC = false;
}

/* ===== REGISTRO CLIENTE ===== */
function registrarCliente() {
  if (
    !nombre.value.trim() ||
    !telefono.value.trim() ||
    !tarjetaUID ||
    diasMembresia === 0
  ) {
    mostrarConfirm("Datos incompletos",
      "Complete todos los campos");
    return;
  }

  const expira = new Date();
  expira.setDate(expira.getDate() + diasMembresia);

  const cliente = {
    id: crypto.randomUUID(),
    nombre: nombre.value.trim(),
    peso: peso.value,
    altura: altura.value,
    telefono: telefono.value,
    tarjetaUID,
    membresiaExpira: expira.toISOString().split("T")[0],
    fechaRegistro: hoy()
  };

  registrarClienteOffline(cliente);

  mostrarConfirm(
    "Registro completado",
    "Cliente registrado correctamente"
  );

  setTimeout(() => location.href = "index.html", 1800);
}

/* ===== OFFLINE + SUPABASE (CLAVE) ===== */
function registrarClienteOffline(cliente) {
  const lista = obtenerClientes();
  lista.push(cliente);

  safeSet("clientes", lista);

  new BroadcastChannel("victory-data").postMessage("clientes");

  if (typeof insertarClienteSupabase === "function") {
    insertarClienteSupabase(cliente);
  }
}

/* ===== HELPERS ===== */
function obtenerClientes() {
  return safeGet("clientes");
}

function uidYaRegistrada(uid) {
  return obtenerClientes().some(c => c.tarjetaUID === uid);
}

/* ===== CONFIRM ===== */
function mostrarConfirm(t, m) {
  confirmacion.style.display = "flex";
  tituloConfirm.innerText = t;
  mensajeConfirm.innerText = m;
}
</script>

</body>
</html>
