<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stock</title>

<link rel="stylesheet" href="css/styles.css">

<!-- SUPABASE (ESTA ES LA BUENA) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- ===== ADAPTACI√ìN SOLO TAMA√ëO M√ìVIL ===== -->
<style>
@media (max-width:768px){

  .header-brand{
    flex-direction:column;
    gap:14px;
    padding:18px;
    text-align:center;
  }

  .brand{
    flex-direction:column;
    gap:8px;
  }

  .brand img{
    height:70px;
  }

  .brand h2{
    font-size:20px;
  }

  .header-brand > div:last-child{
    flex-direction:column;
    width:100%;
  }

  .header-brand button{
    width:100%;
  }

  .card.stock-nuevo{
    width:92%;
    margin:20px auto;
    padding:24px 18px;
  }

  .card.stock-nuevo .stock-form{
    grid-template-columns:1fr !important;
    gap:12px;
  }

  .card.stock-nuevo input,
  .card.stock-nuevo button{
    width:100% !important;
    height:46px;
    font-size:14px;
  }

  .search-bar{
    width:92%;
  }

  .search-bar input{
    height:46px;
    font-size:15px;
  }

  .stock-grid{
    width:92%;
    grid-template-columns:1fr;
  }

  .stock-card{
    padding:18px;
  }

  .stock-card h4{
    font-size:16px;
  }

  .stock-card input{
    height:44px;
    font-size:14px;
    margin-top:6px;
  }

  .stock-footer{
    width:92%;
    text-align:center;
  }

  .stock-footer button{
    width:100%;
    margin-top:10px;
    height:46px;
  }

  .modal-card{
    width:92%;
  }

}
</style>
</head>

<body onload="initStock()">

<header class="header-brand">
  <div class="brand">
    <img src="img/logo.png">
    <h2>Stock</h2>
  </div>

  <div style="display:flex; gap:10px;">
    <button onclick="abrirModalHistorial()" style="opacity:.85">
      Historial de Cambios
    </button>
    <button onclick="location.href='index.html'">‚Üê Inicio</button>
  </div>
</header>

<!-- ================= MODAL MASTER ================= -->
<div id="modalMaster" class="modal-overlay">
  <div class="modal-card pop">
    <h3>üîí Acceso restringido</h3>
    <p>Ingresa la contrase√±a maestra</p>
    <input id="inputMaster" type="password">
    <div id="msgMaster" class="modal-msg"></div>
    <div class="modal-actions">
      <button onclick="cerrarModal()">Cancelar</button>
      <button class="btn-ok" onclick="confirmarMaster()">Entrar</button>
    </div>
  </div>
</div>

<!-- ================= NUEVO PRODUCTO (SOLO EDICI√ìN) ================= -->
<div
  class="card stock-nuevo"
  data-permission="products_create"
  id="panelNuevoProducto"
  style="display:none"
>
  <h3>Nuevo producto</h3>
  <div class="stock-form">
    <input id="inputNombre" placeholder="Nombre">
    <input id="inputPrecio" type="number" step="0.01" placeholder="Precio">
    <input id="inputStock" type="number" placeholder="Stock inicial">
    <button onclick="solicitarAltaProducto()">Agregar</button>
  </div>
</div>

<!-- ================= BUSCADOR ================= -->
<div class="search-bar">
  <input id="buscadorStock" placeholder="Buscar producto...">
</div>

<!-- ================= LISTA ================= -->
<div class="stock-grid" id="listaStock"></div>

<!-- ================= PANEL EDICI√ìN ================= -->
<div class="stock-footer" id="panelEdicion"></div>

<!-- CORE -->
<script src="js/auth.js"></script>
<script src="js/realtime.js"></script>

<script>
/* ================= STATE ================= */
let productos = [];
let productosFiltrados = [];
let modoEdicion = false;
let accionMaster = null;

/* ================= DOM ================= */
const inputNombre   = document.getElementById("inputNombre");
const inputPrecio   = document.getElementById("inputPrecio");
const inputStock    = document.getElementById("inputStock");
const buscadorStock = document.getElementById("buscadorStock");
const listaStock    = document.getElementById("listaStock");
const panelEdicion  = document.getElementById("panelEdicion");
const panelNuevoProducto = document.getElementById("panelNuevoProducto");

/* ================= INIT ================= */
function initStock() {
  if (!verificarSesion()) return;
  if (!can("stock_view")) location.href = "index.html";

  buscadorStock.oninput = filtrarStock;

  iniciarSyncStock();
  cargarStock();
  applyPermissions();
}

/* ================= SYNC ================= */
function iniciarSyncStock() {
  const bc = new BroadcastChannel("victory-data");

  bc.onmessage = e => {
    if (e.data === "productos") cargarStock();
  };

  window.addEventListener("storage", e => {
    if (e.key === "productos") cargarStock();
  });
}

/* ================= DATA ================= */
function cargarStock() {
  productos = JSON.parse(localStorage.getItem("productos") || "[]");
  productosFiltrados = [...productos];
  renderStock();
}

/* ================= RENDER ================= */
function renderStock() {
  listaStock.innerHTML = "";

  if (!productosFiltrados.length) {
    listaStock.innerHTML = "<p style='opacity:.6'>No hay productos</p>";
    return;
  }

  productosFiltrados.forEach(p => {
    const bajo = Number(p.stock) <= Number(p.stock_minimo || 0);

    const card = document.createElement("div");
    card.className = "stock-card" + (bajo ? " bajo" : "");

    card.innerHTML = `
      <h4 style="${bajo ? "color:#e74c3c" : ""}">${p.nombre}</h4>
      <div class="precio">$${Number(p.precio).toFixed(2)}</div>

      ${
        !modoEdicion
        ? `
          <div class="stock-cantidad">Stock: <span>${p.stock}</span></div>
          <div class="small">Stock m√≠nimo: ${p.stock_minimo || 0}</div>
        `
        : `
          <input value="${p.nombre}">
          <input type="number" value="${p.precio}">
          <input type="number" value="${p.stock}">
          <input type="number" value="${p.stock_minimo || 0}">
          <input type="number" placeholder="Cantidad exacta (opcional)">
        `
      }
    `;

    listaStock.appendChild(card);
  });

  renderPanel();
}

/* ================= PANEL EDICI√ìN ================= */
function renderPanel() {
  panelEdicion.innerHTML = "";

  if (!modoEdicion) {
    panelNuevoProducto.style.display = "none";

    const btn = document.createElement("button");
    btn.textContent = "‚úèÔ∏è Editar stock";
    btn.onclick = () => {
      modoEdicion = true;
      renderStock();
    };
    panelEdicion.appendChild(btn);
  } else {
    panelNuevoProducto.style.display = "block";

    const guardar = document.createElement("button");
    guardar.className = "btn-guardar";
    guardar.textContent = "üíæ Guardar cambios";
    guardar.onclick = () => {
      accionMaster = "guardar";
      abrirModalMaster();
    };

    const cancelar = document.createElement("button");
    cancelar.textContent = "‚ùå Cancelar";
    cancelar.onclick = () => {
      modoEdicion = false;
      cargarStock();
    };

    panelEdicion.appendChild(guardar);
    panelEdicion.appendChild(cancelar);
  }
}

/* ================= MODAL ================= */
function abrirModalHistorial() {
  accionMaster = "historial";
  abrirModalMaster();
}

function solicitarAltaProducto() {
  accionMaster = "nuevo";
  abrirModalMaster();
}

function abrirModalMaster() {
  modalMaster.style.display = "flex";
  inputMaster.value = "";
  msgMaster.textContent = "";
  msgMaster.className = "modal-msg";
}

function cerrarModal() {
  modalMaster.style.display = "none";
}

/* ================= CONFIRMAR ================= */
function confirmarMaster() {
  if (!validarPasswordMaestra(inputMaster.value)) {
    msgMaster.textContent = "‚úñ Contrase√±a incorrecta";
    msgMaster.className = "modal-msg error";
    return;
  }

  cerrarModal();

  if (accionMaster === "historial") {
    location.href = "historialstock.html";
    return;
  }

  if (accionMaster === "guardar") guardarCambiosStock();
  if (accionMaster === "nuevo") confirmarNuevoProducto();
}

/* ================= GUARDAR CAMBIOS ================= */
async function guardarCambiosStock() {
  const cards = document.querySelectorAll(".stock-card");

  for (let i = 0; i < cards.length; i++) {
    const inputs = cards[i].querySelectorAll("input");
    if (!inputs.length) continue;

    const nombre = inputs[0].value.trim();
    const precio = Number(inputs[1].value);
    const stockEdit = Number(inputs[2].value);
    const stockMin = Number(inputs[3].value);
    const exacto = inputs[4].value;
    const nuevoStock = exacto !== "" ? Number(exacto) : stockEdit;

    const prod = productosFiltrados[i];
    const antes = { stock: prod.stock, precio: prod.precio };

    prod.nombre = nombre;
    prod.precio = precio;
    prod.stock = nuevoStock;
    prod.stock_minimo = stockMin;

    await supabaseClient
      .from("productos")
      .update({ nombre, precio, stock: nuevoStock, stock_minimo: stockMin })
      .eq("id", prod.id);

    await pushHistorialStock([{
      producto_id: prod.id,
      nombre,
      antes,
      despues: { stock: nuevoStock, precio }
    }]);
  }

  localStorage.setItem("productos", JSON.stringify(productos));
  location.reload();
}

/* ================= NUEVO PRODUCTO ================= */
async function confirmarNuevoProducto() {
  if (!inputNombre.value || !inputPrecio.value) return;

  const prod = {
    id: crypto.randomUUID(),
    nombre: inputNombre.value.trim(),
    precio: Number(inputPrecio.value),
    stock: Number(inputStock.value) || 0,
    stock_minimo: 0
  };

  await insertarProductoSupabase(prod);

  await pushHistorialStock([{
    producto_id: prod.id,
    nombre: prod.nombre,
    antes: null,
    despues: { stock: prod.stock, precio: prod.precio }
  }]);

  inputNombre.value = "";
  inputPrecio.value = "";
  inputStock.value = "";

  location.reload();
}

/* ================= FILTRO ================= */
function filtrarStock() {
  const q = buscadorStock.value.toLowerCase();
  productosFiltrados = productos.filter(p =>
    p.nombre.toLowerCase().includes(q)
  );
  renderStock();
}
</script>

</body>
</html>

