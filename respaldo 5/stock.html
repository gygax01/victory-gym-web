<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Stock</title>
<link rel="stylesheet" href="css/styles.css">
</head>

<body>

<header class="header-brand">
  <div class="brand">
    <img src="img/logo.png" alt="Victory Pro Fitness">
    <h2>Stock</h2>
  </div>
  <button onclick="location.href='index.html'">â† Inicio</button>
</header>

<!-- ===== NUEVO PRODUCTO ===== -->
<div class="card stock-nuevo">
  <h3>Nuevo producto</h3>
  <div class="stock-form">
    <input id="inputNombre" placeholder="Nombre">
    <input id="inputPrecio" type="number" min="0" step="0.01" placeholder="Precio">
    <input id="inputStock" type="number" min="0" step="1" placeholder="Stock inicial">
    <button id="btnAgregar" data-permission="products_create">
      Agregar
    </button>
  </div>
</div>

<!-- ===== BUSCADOR ===== -->
<div class="search-bar">
  <input id="buscadorStock" placeholder="Buscar...">
</div>

<!-- ===== LISTA ===== -->
<div class="stock-grid" id="listaStock"></div>

<!-- ===== FOOTER ===== -->
<div class="stock-footer">
  <button id="btnGuardar" data-permission="stock_add">
    ğŸ’¾ Guardar
  </button>
</div>

<!-- ===== JS BASE (ORDEN IMPORTANTE) ===== -->
<script src="js/storage.js"></script>
<script src="js/auth.js"></script>

<script>
/* ===============================
   ===== DOM =====
=============================== */
const inputNombre = document.getElementById("inputNombre");
const inputPrecio = document.getElementById("inputPrecio");
const inputStock = document.getElementById("inputStock");
const btnAgregar = document.getElementById("btnAgregar");
const buscadorStock = document.getElementById("buscadorStock");
const listaStock = document.getElementById("listaStock");
const btnGuardar = document.getElementById("btnGuardar");

/* ===============================
   ===== ESTADO =====
=============================== */
let productos = [];
let productosFiltrados = [];

/* ===============================
   ===== INIT =====
=============================== */
window.addEventListener("load", initStock);

function initStock() {
  if (!verificarSesion()) return;
  if (!requirePermission("stock_view")) return;

  btnAgregar.addEventListener("click", nuevoProducto);
  btnGuardar.addEventListener("click", guardarStock);
  buscadorStock.addEventListener("input", filtrarStock);

  cargarStock();
  applyPermissions();
}

/* ===============================
   ===== CARGAR / RENDER =====
=============================== */
function cargarStock() {
  productos = obtenerProductos().filter(
    p => p && typeof p.nombre === "string"
  );
  productosFiltrados = [...productos];
  renderStock();
}

function renderStock() {
  listaStock.innerHTML = "";

  if (productosFiltrados.length === 0) {
    const p = document.createElement("p");
    p.textContent = "No hay productos";
    listaStock.appendChild(p);
    return;
  }

  productosFiltrados.forEach((p, idx) => {
    const card = document.createElement("div");
    card.className = "stock-card";

    const header = document.createElement("div");
    header.className = "stock-header";

    const nombre = document.createElement("h4");
    nombre.textContent = p.nombre;

    const btnEliminar = document.createElement("button");
    btnEliminar.textContent = "Eliminar";
    btnEliminar.setAttribute("data-permission", "stock_delete");
    btnEliminar.addEventListener("click", () =>
      eliminarProducto(p)
    );

    header.append(nombre, btnEliminar);

    const precio = document.createElement("div");
    precio.textContent = "$" + Number(p.precio).toFixed(2);

    const stock = document.createElement("div");
    stock.textContent = "Stock: " + (Number(p.stock) || 0);

    const btnMas1 = document.createElement("button");
    btnMas1.textContent = "+1";
    btnMas1.setAttribute("data-permission", "stock_add");
    btnMas1.addEventListener("click", () => sumarStock(p, 1));

    const btnMas10 = document.createElement("button");
    btnMas10.textContent = "+10";
    btnMas10.setAttribute("data-permission", "stock_add");
    btnMas10.addEventListener("click", () => sumarStock(p, 10));

    card.append(header, precio, stock, btnMas1, btnMas10);
    listaStock.appendChild(card);
  });

  applyPermissions();
}

/* ===============================
   ===== OPERACIONES =====
=============================== */
function sumarStock(producto, cantidad) {
  if (!requirePermission("stock_add")) return;
  producto.stock = (Number(producto.stock) || 0) + cantidad;
  renderStock();
}

function eliminarProducto(producto) {
  if (!requirePermission("stock_delete")) return;
  productos = productos.filter(p => p !== producto);
  productosFiltrados = productosFiltrados.filter(p => p !== producto);
  guardarStock();
}

function guardarStock() {
  if (!requirePermission("stock_add")) return;
  guardarProductos(productos);
  alert("Stock guardado");
}

/* ===============================
   ===== NUEVO PRODUCTO =====
=============================== */
function nuevoProducto() {
  if (!requirePermission("products_create")) return;

  const nombre = inputNombre.value.trim();
  const precio = Number(inputPrecio.value);
  const stock = Number(inputStock.value);

  if (!nombre || isNaN(precio) || isNaN(stock)) {
    alert("Datos invÃ¡lidos");
    return;
  }

  productos.push({ nombre, precio, stock });
  inputNombre.value = "";
  inputPrecio.value = "";
  inputStock.value = "";

  guardarStock();
}

/* ===============================
   ===== FILTRO =====
=============================== */
function filtrarStock() {
  const q = buscadorStock.value.toLowerCase();
  productosFiltrados = productos.filter(
    p => p.nombre.toLowerCase().includes(q)
  );
  renderStock();
}
</script>

</body>
</html>


