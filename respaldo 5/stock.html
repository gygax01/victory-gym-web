<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Stock</title>
<link rel="stylesheet" href="css/styles.css">
</head>

<body onload="verificarSesion(); requirePermission('stock_view'); cargar(); applyPermissions();">

<header class="header-brand">
  <div class="brand">
    <img src="img/logo.png">
    <h2>Stock</h2>
  </div>
  <button onclick="location.href='index.html'">â† Inicio</button>
</header>

<div class="card stock-nuevo">
  <h3>Nuevo producto</h3>
  <div class="stock-form">
    <input id="nNombre" placeholder="Nombre">
    <input id="nPrecio" type="number" placeholder="Precio">
    <input id="nStock" type="number" placeholder="Stock inicial">
    <button data-permission="products_create" onclick="nuevo()">Agregar</button>
  </div>
</div>

<div class="search-bar">
  <input id="buscadorStock" placeholder="Buscar..." oninput="filtrarStock()">
</div>

<div class="stock-grid" id="lista"></div>

<div class="stock-footer">
  <button data-permission="stock_add" onclick="guardar()">ğŸ’¾ Guardar</button>
</div>

<script src="js/storage.js"></script>
<script src="js/auth.js"></script>

<script>
let productos = [];
let productosFiltrados = [];

function cargar(){
  productos = obtenerProductos();
  productosFiltrados = productos;
  render();
}

function render(){
  lista.innerHTML = "";
  productosFiltrados.forEach((p,i)=>{
    const d=document.createElement("div");
    d.className="stock-card";
    d.innerHTML=`
      <div class="stock-header">
        <h4>${p.nombre}</h4>
        <button data-permission="stock_delete"
          onclick="eliminar(${i})">Eliminar</button>
      </div>
      <div>$${p.precio}</div>
      <div>Stock: ${p.stock}</div>
      <button data-permission="stock_add" onclick="sumar(${i},1)">+1</button>
      <button data-permission="stock_add" onclick="sumar(${i},10)">+10</button>
    `;
    lista.appendChild(d);
  });
  applyPermissions();
}

function sumar(i,c){
  requirePermission("stock_add");
  productosFiltrados[i].stock+=c;
  render();
}

function eliminar(i){
  requirePermission("stock_delete");
  productos.splice(i,1);
  guardar();
}

function guardar(){
  requirePermission("stock_add");
  guardarProductos(productos);
  alert("Stock guardado");
}

function nuevo(){
  requirePermission("products_create");
  productos.push({
    nombre:nNombre.value,
    precio:Number(nPrecio.value),
    stock:Number(nStock.value)
  });
  guardar();
}

function filtrarStock(){
  const q=buscadorStock.value.toLowerCase();
  productosFiltrados=productos.filter(p=>p.nombre.toLowerCase().includes(q));
  render();
}
</script>

</body>
</html>
