<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Stock</title>

<link rel="stylesheet" href="css/styles.css">

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<header class="header-brand">
  <div class="brand">
    <img src="img/logo.png" alt="Victory Pro Fitness">
    <h2>Stock</h2>
  </div>
  <button onclick="location.href='index.html'">← Inicio</button>
</header>

<!-- ================= NUEVO PRODUCTO ================= -->
<div class="card stock-nuevo" data-permission="products_create">
  <h3>Nuevo producto</h3>
  <div class="stock-form">
    <input id="inputNombre" placeholder="Nombre">
    <input id="inputPrecio" type="number" step="0.01" placeholder="Precio">
    <input id="inputStock" type="number" placeholder="Stock inicial">
    <button id="btnAgregar">Agregar</button>
  </div>
</div>

<!-- ================= BUSCADOR ================= -->
<div class="search-bar">
  <input id="buscadorStock" placeholder="Buscar producto...">
</div>

<!-- ================= LISTA ================= -->
<div class="stock-grid" id="listaStock"></div>

<!-- ================= CORE ================= -->
<script src="js/auth.js"></script>
<script src="js/realtime.js"></script>

<script>
/* ======================================================
   ===================== DOM =============================
====================================================== */
const inputNombre   = document.getElementById("inputNombre");
const inputPrecio   = document.getElementById("inputPrecio");
const inputStock    = document.getElementById("inputStock");
const btnAgregar    = document.getElementById("btnAgregar");
const buscadorStock = document.getElementById("buscadorStock");
const listaStock    = document.getElementById("listaStock");

/* ======================================================
   ===================== STATE ===========================
====================================================== */
let productos = [];
let productosFiltrados = [];

/* ======================================================
   ===================== INIT ============================
====================================================== */
function initStock() {
  if (!verificarSesion()) return;
  if (!can("stock_view")) {
    location.href = "index.html";
    return;
  }

  btnAgregar.addEventListener("click", nuevoProducto);
  buscadorStock.addEventListener("input", filtrarStock);

  iniciarSyncStock();
  cargarStock();
  applyPermissions();
}

window.addEventListener("load", initStock);

/* ======================================================
   ===================== SYNC ============================
====================================================== */
function iniciarSyncStock() {
  const bc = new BroadcastChannel("victory-data");

  bc.onmessage = e => {
    if (e.data === "productos") cargarStock();
  };

  window.addEventListener("storage", e => {
    if (e.key === "productos") cargarStock();
  });
}

/* ======================================================
   ===================== DATA ============================
====================================================== */
function cargarStock() {
  try {
    productos = JSON.parse(localStorage.getItem("productos")) || [];
  } catch {
    productos = [];
  }

  productosFiltrados = [...productos];
  renderStock();
}

/* ======================================================
   ===================== RENDER ==========================
====================================================== */
function renderStock() {
  listaStock.innerHTML = "";

  if (!productosFiltrados.length) {
    listaStock.innerHTML = "<p style='opacity:.7'>No hay productos</p>";
    return;
  }

  productosFiltrados.forEach(p => {
    const card = document.createElement("div");
    card.className = "stock-card";

    card.innerHTML = `
      <div class="stock-header">
        <h4>${p.nombre}</h4>
      </div>

      <div class="precio">$${Number(p.precio).toFixed(2)}</div>

      <div class="stock-cantidad">
        Stock: <span>${p.stock}</span>
      </div>

      <div class="stock-botones">
        <button data-permission="stock_add">+1</button>
        <button data-permission="stock_add">+10</button>
        <button class="btn-eliminar" data-permission="stock_delete">
          Eliminar
        </button>
      </div>
    `;

    const botones = card.querySelectorAll("button");
    const btn1  = botones[0];
    const btn10 = botones[1];
    const btnDel = botones[2];

    btn1.onclick  = () => cambiarStock(p, 1);
    btn10.onclick = () => cambiarStock(p, 10);
    btnDel.onclick = () => eliminarProducto(p.id);

    listaStock.appendChild(card);
  });

  applyPermissions();
}

/* ======================================================
   ===================== ACCIONES ========================
====================================================== */
async function cambiarStock(producto, delta) {
  if (!can("stock_add")) return;

  const nuevoStock = producto.stock + delta;
  if (nuevoStock < 0) return;

  await actualizarStockSupabase(producto.id, nuevoStock);
}

async function eliminarProducto(id) {
  if (!can("stock_delete")) return;

  const ok = confirm("¿Eliminar producto?");
  if (!ok) return;

  await borrarProductoSupabase(id);
}

async function nuevoProducto() {
  if (!can("products_create")) return;

  const nombre = inputNombre.value.trim();
  const precio = Number(inputPrecio.value);
  const stock  = Number(inputStock.value) || 0;

  if (!nombre || isNaN(precio)) return;

  await insertarProductoSupabase({
    id: crypto.randomUUID(),
    nombre,
    precio,
    stock
  });

  inputNombre.value = "";
  inputPrecio.value = "";
  inputStock.value  = "";
}

/* ======================================================
   ===================== FILTRO ==========================
====================================================== */
function filtrarStock() {
  const q = buscadorStock.value.toLowerCase();

  productosFiltrados = productos.filter(p =>
    p.nombre.toLowerCase().includes(q)
  );

  renderStock();
}
</script>

</body>
</html>
