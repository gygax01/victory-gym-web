<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Stock</title>
<link rel="stylesheet" href="css/styles.css">
</head>

<body>

<header class="header-brand">
  <div class="brand">
    <img src="img/logo.png">
    <h2>Stock</h2>
  </div>
  <button onclick="location.href='index.html'">‚Üê Inicio</button>
</header>

<!-- ===== NUEVO PRODUCTO ===== -->
<div class="card stock-nuevo" data-permission="products_create">
  <h3>Nuevo producto</h3>
  <div class="stock-form">
    <input id="inputNombre" placeholder="Nombre">
    <input id="inputPrecio" type="number" step="0.01" placeholder="Precio">
    <input id="inputStock" type="number" placeholder="Stock inicial">
    <button id="btnAgregar">Agregar</button>
  </div>
</div>

<!-- ===== BUSCADOR ===== -->
<div class="search-bar">
  <input id="buscadorStock" placeholder="Buscar...">
</div>

<!-- ===== LISTA ===== -->
<div class="stock-grid" id="listaStock"></div>

<!-- ===== FOOTER ===== -->
<div class="stock-footer" data-permission="stock_add">
  <button id="btnGuardar">üíæ Guardar</button>
</div>

<!-- ===== JS BASE ===== -->
<script src="js/storage.js"></script>

<!-- üî• CACHE BUSTING PARA GITHUB PAGES -->
<script src="js/auth.js?v=4"></script>

<script>
const inputNombre = document.getElementById("inputNombre");
const inputPrecio = document.getElementById("inputPrecio");
const inputStock = document.getElementById("inputStock");
const btnAgregar = document.getElementById("btnAgregar");
const buscadorStock = document.getElementById("buscadorStock");
const listaStock = document.getElementById("listaStock");
const btnGuardar = document.getElementById("btnGuardar");

let productos = [];
let productosFiltrados = [];

window.addEventListener("load", () => {
  if (!verificarSesion()) return;

  // ‚úÖ acceso permitido a empleados y admin
  if (!can("stock_view")) {
    location.href = "index.html";
    return;
  }

  btnAgregar?.addEventListener("click", nuevoProducto);
  btnGuardar?.addEventListener("click", guardarStock);
  buscadorStock.addEventListener("input", filtrarStock);

  cargarStock();
  applyPermissions();
});

function cargarStock() {
  productos = obtenerProductos().filter(p => p && p.nombre);
  productosFiltrados = [...productos];
  renderStock();
}

function renderStock() {
  listaStock.innerHTML = "";

  if (!productosFiltrados.length) {
    listaStock.innerHTML = "<p>No hay productos</p>";
    return;
  }

  productosFiltrados.forEach(p => {
    const card = document.createElement("div");
    card.className = "stock-card";

    card.innerHTML = `
      <h4>${p.nombre}</h4>
      <div>$${Number(p.precio).toFixed(2)}</div>
      <div>Stock: ${p.stock}</div>
      <button data-permission="stock_add">+1</button>
      <button data-permission="stock_add">+10</button>
      <button data-permission="stock_delete">Eliminar</button>
    `;

    const [b1, b10, bDel] = card.querySelectorAll("button");

    b1.onclick = () => modificarStock(p, 1);
    b10.onclick = () => modificarStock(p, 10);
    bDel.onclick = () => eliminarProducto(p);

    listaStock.appendChild(card);
  });

  applyPermissions();
}

function modificarStock(p, cant) {
  if (!can("stock_add")) return;
  p.stock += cant;
  renderStock();
}

function eliminarProducto(p) {
  if (!can("stock_delete")) return;
  productos = productos.filter(x => x !== p);
  guardarStock();
}

function guardarStock() {
  if (!can("stock_add")) return;
  guardarProductos(productos);
}

function nuevoProducto() {
  if (!can("products_create")) return;

  productos.push({
    nombre: inputNombre.value,
    precio: Number(inputPrecio.value),
    stock: Number(inputStock.value)
  });

  inputNombre.value = "";
  inputPrecio.value = "";
  inputStock.value = "";

  guardarStock();
}

function filtrarStock() {
  const q = buscadorStock.value.toLowerCase();
  productosFiltrados = productos.filter(p =>
    p.nombre.toLowerCase().includes(q)
  );
  renderStock();
}
</script>

</body>
</html>
