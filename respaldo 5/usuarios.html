<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro de Usuario</title>
  <link rel="stylesheet" href="css/styles.css">

  <!-- SUPABASE (solo para NFC / realtime) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>

  <!-- CORE (SIN AUTH) -->
  <script src="js/storage.js" defer></script>
  <script src="js/realtime.js" defer></script>

  <!-- NFC -->
  <script src="js/nfc.js" defer></script>
</head>

<body>

<header class="header-brand">
  <div class="brand">
    <img src="img/logo.png" alt="Victory Pro Fitness">
    <h2>Registro de Usuario</h2>
  </div>

  <button class="btn-volver" onclick="location.href='login.html'">
    ‚Üê Volver
  </button>
</header>

<main class="main">
  <div class="card registro-pc">

    <!-- COLUMNA IZQUIERDA -->
    <div class="registro-col">
      <h3>Datos del usuario</h3>

      <input id="nombre" placeholder="Nombre completo">
      <input id="usuario" placeholder="Usuario">
      <input id="password" type="password" placeholder="Contrase√±a del usuario">

      <select id="rol">
        <option value="">Seleccione rol</option>
        <option value="employee">Empleado</option>
        <option value="admin">Administrador</option>
        <option value="superadmin">Super Admin</option>
      </select>
    </div>

    <!-- COLUMNA DERECHA -->
    <div class="registro-col">
      <h3>Tarjeta NFC</h3>

      <button class="nfc" id="btnAsignar">
        Asignar tarjeta
      </button>

      <p id="uidTexto"></p>

      <hr>

      <input
        id="passwordMaestra"
        type="password"
        placeholder="Contrase√±a maestra"
      >

      <button id="finalizar">
        Registrar usuario
      </button>
    </div>

  </div>
</main>

<!-- POPUP NFC -->
<div class="overlay" id="overlay">
  <div class="popup">
    <h2>Acerque la tarjeta</h2>
    <div id="estado" class="estado amarillo">Esperando tarjeta‚Ä¶</div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  let tarjetaUID = null;
  let leyendoNFC = false;

  /* ===============================
     ===== NFC =====
  =============================== */
  btnAsignar.onclick = () => {
    if (leyendoNFC) return;

    tarjetaUID = null;
    leyendoNFC = true;

    overlay.style.display = "flex";
    estado.className = "estado amarillo";
    estado.innerText = "Esperando tarjeta‚Ä¶";

    iniciarNFCControlado({
      onUID: uid => {
        if (uidYaRegistrada(uid)) {
          estado.className = "estado rojo";
          estado.innerText = "Tarjeta ya registrada";
          setTimeout(cerrarPopup, 1500);
          return;
        }

        tarjetaUID = uid;
        uidTexto.innerText = "UID: " + uid;
        estado.className = "estado verde";
        estado.innerText = "Tarjeta asignada";

        setTimeout(cerrarPopup, 1200);
      }
    });
  };

  function cerrarPopup() {
    overlay.style.display = "none";
    detenerNFC();
    leyendoNFC = false;
  }

  /* ===============================
     ===== REGISTRO USUARIO =====
  =============================== */
  finalizar.onclick = () => {
    if (
      !nombre.value.trim() ||
      !usuario.value.trim() ||
      !password.value.trim() ||
      !rol.value ||
      !tarjetaUID ||
      !passwordMaestra.value
    ) {
      alert("Complete todos los campos");
      return;
    }

    // üîê CONTRASE√ëA MAESTRA
    const MASTER_PASSWORD = "123456"; // ‚Üê c√°mbiala aqu√≠

    if (passwordMaestra.value !== MASTER_PASSWORD) {
      alert("Contrase√±a maestra incorrecta");
      return;
    }

    const empleados = obtenerEmpleados();

    empleados.push({
      id: crypto.randomUUID(),
      nombre: nombre.value.trim(),
      usuario: usuario.value.trim(),
      password: password.value,
      rol: rol.value,
      tarjetaUID
    });

    guardarEmpleados(empleados);

    alert("Usuario registrado correctamente");
    location.href = "login.html";
  };

});
</script>

</body>
</html>
