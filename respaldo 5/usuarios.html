<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Usuarios</title>
  <link rel="stylesheet" href="css/styles.css">

  <!-- SUPABASE -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- CORE -->
  <script src="js/storage.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/nfc.js"></script>
  <script src="js/realtime.js"></script>

  <!-- ===== ADAPTACIÓN SOLO TAMAÑO MÓVIL ===== -->
  <style>
  @media (max-width:768px){

    .header-brand{
      flex-direction:column;
      gap:14px;
      padding:18px;
      text-align:center;
    }

    .brand{
      flex-direction:column;
      gap:8px;
    }

    .brand img{
      height:70px;
    }

    .brand h2{
      font-size:20px;
    }

    header button{
      width:100%;
      margin-left:0;
    }

    .card.usuarios-pc{
      grid-template-columns:1fr !important;
      padding:28px 20px;
      gap:20px;
    }

    .usuarios-col input,
    .usuarios-col select{
      height:46px;
      font-size:15px;
    }

    .usuarios-col button{
      width:100%;
      margin-top:10px;
      height:46px;
      font-size:15px;
    }

    #buscador{
      width:92%;
    }

    #buscador input{
      height:46px;
      font-size:15px;
    }

    .historial-container{
      width:92%;
    }

    .cliente{
      padding:16px;
    }

    .cliente h3{
      font-size:18px;
    }

    .confirmacion .box{
      width:92%;
      padding:40px 20px;
    }

    .popup{
      width:92%;
      padding:30px 20px;
    }

  }
  </style>
</head>

<body onload="initUsuarios()">

<header class="header-brand">
  <div class="brand">
    <img src="img/logo.png">
    <h2>Gestión de usuarios</h2>
  </div>
  <button onclick="volver()">← Volver</button>
</header>

<!-- ================= REGISTRO ================= -->
<div class="card usuarios-pc" id="registroCard">
  <div class="usuarios-col">
    <h3>Registrar usuario</h3>

    <input id="nombre" placeholder="Nombre completo">
    <input id="usuario" placeholder="Usuario">
    <input id="password" type="password" placeholder="Contraseña">

    <select id="rol">
      <option value="employee">Empleado</option>
      <option value="admin">Administrador</option>
    </select>

    <button class="nfc" onclick="asignarTarjeta()">Asignar tarjeta</button>
    <p id="uidTexto" class="uid"></p>
  </div>

  <div class="usuarios-col">
    <button id="btnRegistrar" onclick="pedirClaveRegistro()" disabled>
      Registrar usuario
    </button>
  </div>
</div>

<!-- ================= BUSCADOR / LISTAS ================= -->
<div class="search-bar" id="buscador">
  <input id="busqueda" placeholder="Buscar usuario..." oninput="renderUsuarios()">
</div>

<div class="historial-container" id="listasUsuarios">
  <h3>Administradores</h3>
  <div id="listaAdmins"></div>

  <h3 style="margin-top:30px">Empleados</h3>
  <div id="listaEmpleados"></div>
</div>

<!-- ================= NFC ================= -->
<div class="overlay" id="overlay">
  <div class="popup">
    <h2>Acerque la tarjeta</h2>
    <div id="estado" class="estado amarillo">Esperando tarjeta…</div>
  </div>
</div>

<!-- ================= CONFIRM ================= -->
<div class="confirmacion" id="confirmacion">
  <div class="box">
    <h1 id="tituloConfirm"></h1>
    <p id="mensajeConfirm"></p>
    <div id="accionesConfirm"></div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const CLAVE_MAESTRA = "victory(profitness)";
let tarjetaUID = null;

/* ================= INIT ================= */
function initUsuarios() {
  if (!verificarSesion()) return;

  const s = obtenerSesion();
  if (!["admin","superadmin"].includes(s.rol)) {
    location.href = "index.html";
    return;
  }

  iniciarSyncUsuarios();
  renderUsuarios();
}

/* ================= SYNC ================= */
function iniciarSyncUsuarios() {
  const bc = new BroadcastChannel("victory-data");

  bc.onmessage = e => {
    if (e.data === "empleados") renderUsuarios();
  };

  window.addEventListener("storage", e => {
    if (e.key === "empleados") renderUsuarios();
  });

  window.addEventListener("online", () => {
    syncOfflineQueue();
    renderUsuarios();
  });
}

/* ================= VOLVER ================= */
function volver() {
  location.href = "index.html";
}

/* ================= NFC ================= */
function asignarTarjeta() {
  tarjetaUID = null;
  btnRegistrar.disabled = true;

  overlay.style.display = "flex";
  estado.className = "estado amarillo";
  estado.textContent = "Esperando tarjeta…";
  uidTexto.textContent = "";

  iniciarNFCControlado({
    onUID: uid => {
      if (uidYaRegistrada(uid)) {
        estado.className = "estado rojo";
        estado.textContent = "Tarjeta ya registrada";
        setTimeout(cerrarPopup, 1500);
        return;
      }

      tarjetaUID = uid;
      uidTexto.textContent = "UID: " + uid;
      estado.className = "estado verde";
      estado.textContent = "Tarjeta asignada";

      setTimeout(() => {
        cerrarPopup();
        btnRegistrar.disabled = false;
      }, 1200);
    }
  });
}

function cerrarPopup() {
  overlay.style.display = "none";
  detenerNFC();
}

/* ================= REGISTRO ================= */
function pedirClaveRegistro() {
  if (!tarjetaUID) return alert("Asigne una tarjeta primero");

  mostrarConfirm(
    "Acceso administrativo",
    "Ingrese la contraseña maestra",
    `
      <input id="claveInput" type="password">
      <button onclick="confirmarRegistro()">Confirmar</button>
      <button onclick="cerrarConfirm()">Cancelar</button>
    `
  );
}

function confirmarRegistro() {
  if (claveInput.value !== CLAVE_MAESTRA) {
    alert("Contraseña incorrecta");
    return;
  }
  cerrarConfirm();
  registrarUsuario();
}

function registrarUsuario() {
  if (!nombre.value || !usuario.value || !password.value || !tarjetaUID) {
    alert("Complete todos los datos");
    return;
  }

  const empleados = obtenerEmpleados();

  const nuevo = {
    id: crypto.randomUUID(),
    nombre: nombre.value.trim(),
    usuario: usuario.value.trim(),
    password: password.value,
    rol: rol.value,
    tarjetaUID
  };

  empleados.push(nuevo);
  guardarEmpleados(empleados);

  agregarEvento({
    tabla: "empleados",
    accion: "add",
    data: nuevo
  });

  new BroadcastChannel("victory-data").postMessage("empleados");

  mostrarConfirm(
    "Correcto",
    "Usuario registrado correctamente",
    `<button onclick="cerrarConfirm(); location.reload()">Aceptar</button>`
  );
}

/* ================= LISTA ================= */
function renderUsuarios() {
  const q = busqueda.value.toLowerCase();
  const empleados = obtenerEmpleados()
    .filter(e =>
      e.rol !== "superadmin" &&
      (e.nombre.toLowerCase().includes(q) ||
       e.usuario.toLowerCase().includes(q))
    );

  listaAdmins.innerHTML = "";
  listaEmpleados.innerHTML = "";

  empleados.forEach(e => {
    const d = document.createElement("div");
    d.className = "cliente";
    d.innerHTML = `
      <div class="cliente-header">
        <h3>${e.nombre}</h3>
      </div>
      <p class="meta">${e.usuario} · ${e.rol}</p>
    `;

    if (e.rol === "admin") listaAdmins.appendChild(d);
    else listaEmpleados.appendChild(d);
  });
}

/* ================= CONFIRM ================= */
function mostrarConfirm(t, m, a) {
  confirmacion.style.display = "flex";
  tituloConfirm.innerText = t;
  mensajeConfirm.innerHTML = m;
  accionesConfirm.innerHTML = a;
}

function cerrarConfirm() {
  confirmacion.style.display = "none";
}
</script>

</body>
</html>
