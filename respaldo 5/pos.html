<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Punto de Venta</title>
<link rel="stylesheet" href="css/styles.css">

<style>
.pos-wrap{
  max-width:1100px;
  margin:20px auto;
  display:grid;
  grid-template-columns: 2fr 1fr;
  gap:20px;
}
@media(max-width:900px){
  .pos-wrap{grid-template-columns:1fr}
}
.productos{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
  gap:16px;
}
.prod{
  background:linear-gradient(145deg,#3a3a3a,#2a2a2a);
  border-radius:18px;
  padding:26px;
  text-align:center;
  cursor:pointer;
  transition:.15s;
}
.prod:hover{transform:scale(1.06)}
.prod b{display:block;font-size:18px}
.prod span{color:#2ecc71;font-size:22px}
.carrito{
  background:#222;
  border-radius:16px;
  padding:16px;
}
.carrito ul{list-style:none;padding:0;margin:0}
.carrito li{
  display:flex;
  justify-content:space-between;
  margin:6px 0;
}
.total{
  background:#111;
  border-radius:18px;
  padding:20px;
  text-align:center;
  margin:14px 0;
}
.total span{font-size:44px;color:#2ecc71}
.overlay-cambio{
  position:fixed;inset:0;
  background:rgba(0,0,0,.7);
  backdrop-filter:blur(6px);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:5000;
}
.overlay-cambio .box{
  background:#2ecc71;
  color:#fff;
  padding:80px;
  border-radius:22px;
  text-align:center;
}

/* ===== ADAPTACIÓN SOLO TAMAÑO MÓVIL ===== */
@media(max-width:768px){

  header{
    flex-direction:column;
    gap:12px;
    text-align:center;
    padding:18px;
  }

  header button{
    width:100%;
  }

  .pos-wrap{
    width:92%;
    margin:20px auto;
  }

  .productos{
    grid-template-columns:repeat(auto-fill,minmax(130px,1fr));
  }

  .prod{
    padding:20px;
  }

  .prod b{
    font-size:16px;
  }

  .prod span{
    font-size:18px;
  }

  .carrito{
    padding:18px;
  }

  .carrito input{
    width:100%;
    height:46px;
    font-size:15px;
    margin-top:10px;
  }

  .carrito button{
    width:100%;
    margin-top:10px;
    padding:14px;
    font-size:15px;
  }

  .total span{
    font-size:32px;
  }

  .overlay-cambio .box{
    width:90%;
    padding:50px 20px;
  }

}
</style>
</head>

<body onload="initPOS()">

<header>
  <h2>Punto de Venta</h2>
  <button onclick="location.href='index.html'">⬅ Inicio</button>
</header>

<div class="pos-wrap">
  <div>
    <h3>Productos</h3>
    <div class="productos" id="grid"></div>
  </div>

  <div class="carrito">
    <h3>Carrito</h3>
    <ul id="lista"></ul>

    <div class="total">
      Total $<span id="total">0.00</span>
    </div>

    <input id="pago" type="number" placeholder="¿Con cuánto paga?">
    <button onclick="cobrar()">Cobrar</button>
    <button onclick="cancelar()">Cancelar</button>
  </div>
</div>

<div class="overlay-cambio" id="overlay">
  <div class="box">
    <p>Cambio</p>
    <h1>$<span id="cambio">0.00</span></h1>
  </div>
</div>

<script src="js/storage.js"></script>
<script src="js/auth.js"></script>

<!-- SUPABASE v1 (global, compatible) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>

<script src="js/realtime.js"></script>

<script>
/* ================= VARS ================= */
let productos = [];
let carrito = [];
let cobrando = false;

function registrarVenta(){}

/* ================= INIT ================= */
function initPOS(){
  if (!verificarSesion()) return;
  cargarProductos();
  iniciarSyncPOS();
}

/* ================= SYNC ================= */
function iniciarSyncPOS(){
  const bc = new BroadcastChannel("victory-data");

  bc.onmessage = e => {
    if (cobrando) return;
    if (e.data === "productos") cargarProductos();
  };

  window.addEventListener("storage", e => {
    if (cobrando) return;
    if (e.key === "productos") cargarProductos();
  });
}

/* ================= PRODUCTOS ================= */
function cargarProductos(){
  grid.innerHTML = "";
  productos = obtenerProductos().filter(p => p && p.stock > 0);

  if (!productos.length){
    grid.innerHTML = "<p>No hay productos disponibles</p>";
    return;
  }

  productos.forEach(p=>{
    const d = document.createElement("div");
    d.className = "prod";
    d.innerHTML = `<b>${p.nombre}</b><span>$${Number(p.precio).toFixed(2)}</span>`;
    d.onclick = () => agregar(p.id);
    grid.appendChild(d);
  });
}

/* ================= CARRITO ================= */
function agregar(id){
  carrito.push(id);
  render();
}

function render(){
  lista.innerHTML = "";
  let totalVenta = 0;

  carrito.forEach(id=>{
    const p = productos.find(x=>x.id===id);
    if (!p) return;
    totalVenta += Number(p.precio);
    lista.innerHTML += `<li>${p.nombre}<span>$${Number(p.precio).toFixed(2)}</span></li>`;
  });

  total.innerText = totalVenta.toFixed(2);
}

function cancelar(){
  carrito = [];
  pago.value = "";
  render();
}

/* ================= COBRAR ================= */
function cobrar(){
  if (!carrito.length) return alert("Carrito vacío");

  const totalVenta = Number(total.innerText);
  const paga = Number(pago.value);
  if (paga < totalVenta) return alert("Pago insuficiente");

  cobrando = true;

  const stock = obtenerProductos();

  const conteo = {};
  carrito.forEach(id => conteo[id] = (conteo[id] || 0) + 1);

  Object.keys(conteo).forEach(id => {
    const p = stock.find(x => x.id === id);
    if (!p) return;

    p.stock -= conteo[id];

    agregarEvento({
      tabla: "productos",
      accion: "update",
      data: p
    });
  });

  safeSet("productos", stock);
  new BroadcastChannel("victory-data").postMessage("productos");

  cambio.innerText = (paga - totalVenta).toFixed(2);
  overlay.style.display = "flex";

  setTimeout(() => {
    cobrando = false;
    location.href = "index.html";
  }, 3500);
}
</script>

</body>
</html>
