<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Punto de Venta</title>
<link rel="stylesheet" href="css/styles.css">

<style>
/* ===== POS LAYOUT ===== */
.pos-wrap{
  max-width:1100px;
  margin:20px auto;
  display:grid;
  grid-template-columns: 2fr 1fr;
  gap:20px;
}
@media(max-width:900px){
  .pos-wrap{grid-template-columns:1fr}
}

/* ===== PRODUCTOS ===== */
.productos{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
  gap:16px;
}
.prod{
  background:linear-gradient(145deg,#3a3a3a,#2a2a2a);
  border-radius:18px;
  padding:26px;
  text-align:center;
  cursor:pointer;
  transition:.15s;
}
.prod:hover{transform:scale(1.06)}
.prod b{display:block;font-size:18px}
.prod span{color:#2ecc71;font-size:22px}

/* ===== CARRITO ===== */
.carrito{
  background:#222;
  border-radius:16px;
  padding:16px;
}
.carrito ul{list-style:none;padding:0;margin:0}
.carrito li{
  display:flex;
  justify-content:space-between;
  margin:6px 0;
}

/* ===== TOTAL ===== */
.total{
  background:#111;
  border-radius:18px;
  padding:20px;
  text-align:center;
  margin:14px 0;
}
.total span{font-size:44px;color:#2ecc71}

/* ===== OVERLAY CAMBIO ===== */
.overlay-cambio{
  position:fixed;inset:0;
  background:rgba(0,0,0,.7);
  backdrop-filter:blur(6px);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:5000;
}
.overlay-cambio .box{
  background:#2ecc71;
  color:#fff;
  padding:80px;
  border-radius:22px;
  text-align:center;
  animation:zoom .25s ease;
}
.overlay-cambio h1{font-size:64px;margin:0}
@keyframes zoom{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}
</style>
</head>

<body>

<header class="header-brand">
  <div class="brand"><h2>Punto de Venta</h2></div>
  <button onclick="location.href='index.html'">â¬… Inicio</button>
</header>

<div class="pos-wrap">
  <!-- PRODUCTOS -->
  <div>
    <h3>Productos</h3>
    <div class="productos" id="grid"></div>
  </div>

  <!-- CARRITO -->
  <div class="carrito">
    <h3>Carrito</h3>
    <ul id="lista"></ul>

    <div class="total">
      Total $<span id="total">0.00</span>
    </div>

    <input id="pago" type="number" placeholder="Â¿Con cuÃ¡nto paga?">
    <button onclick="cobrar()">Cobrar</button>
    <button onclick="cancelar()">Cancelar</button>
  </div>
</div>

<!-- CAMBIO -->
<div class="overlay-cambio" id="overlay">
  <div class="box">
    <p>Cambio</p>
    <h1>$<span id="cambio">0.00</span></h1>
  </div>
</div>

<script src="js/storage.js"></script>
<script src="js/auth.js"></script>
<script src="js/realtime.js"></script>

<script>
/* ================= ESTADO ================= */
let productos = [];
let carrito = [];

/* ================= INIT ================= */
window.addEventListener("load", initPOS);

function initPOS(){
  if (!verificarSesion()) return;
  if (!requirePermission("sales_do")) return;

  iniciarSyncPOS();
  cargarProductos();
}

/* ================= SYNC ================= */
function iniciarSyncPOS(){
  const bc = new BroadcastChannel("victory-data");

  bc.onmessage = e => {
    if (e.data === "productos") cargarProductos();
  };

  window.addEventListener("storage", e => {
    if (e.key === "productos") cargarProductos();
  });
}

/* ================= PRODUCTOS ================= */
function cargarProductos(){
  grid.innerHTML = "";
  productos = obtenerProductos()
    .filter(p => p && p.nombre && Number(p.stock) > 0);

  if (!productos.length) {
    grid.innerHTML = "<p>No hay productos disponibles</p>";
    return;
  }

  productos.forEach(p => {
    const d = document.createElement("div");
    d.className = "prod";
    d.innerHTML = `<b>${p.nombre}</b><span>$${Number(p.precio).toFixed(2)}</span>`;
    d.onclick = () => agregarProducto(p.id);
    grid.appendChild(d);
  });
}

/* ================= CARRITO ================= */
function agregarProducto(id){
  carrito.push(id);
  render();
}

function render(){
  lista.innerHTML = "";
  let totalVenta = 0;

  carrito.forEach(id => {
    const p = productos.find(x => x.id === id);
    if (!p) return;

    totalVenta += Number(p.precio);

    lista.innerHTML += `
      <li>
        <span>${p.nombre}</span>
        <span>$${Number(p.precio).toFixed(2)}</span>
      </li>
    `;
  });

  total.textContent = totalVenta.toFixed(2);
}

function cancelar(){
  if (!confirm("Â¿Cancelar venta?")) return;
  carrito = [];
  pago.value = "";
  render();
}

/* ================= COBRAR (CORRECTO) ================= */
function cobrar(){
  const totalVenta = Number(total.textContent);
  const paga = Number(pago.value);

  if (!carrito.length) return alert("Carrito vacÃ­o");
  if (paga < totalVenta) return alert("Pago insuficiente");

  /* ðŸ”¥ DESCONTAR STOCK */
  carrito.forEach(id => {
    const p = productos.find(x => x.id === id);
    if (!p) return;

    p.stock = Number(p.stock) - 1;
    actualizarProducto(p);
  });

  /* ðŸ”¥ REGISTRAR VENTA */
  registrarVenta({
    fecha: hoy(),
    hora: horaActual(),
    total: totalVenta
  });

  new BroadcastChannel("victory-data").postMessage("productos");

  /* UI CAMBIO */
  cambio.textContent = (paga - totalVenta).toFixed(2);
  overlay.style.display = "flex";

  setTimeout(() => {
    overlay.style.display = "none";
    location.href = "index.html";
  }, 3500);
}
</script>

</body>
</html>
