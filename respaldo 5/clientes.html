<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clientes</title>
  <link rel="stylesheet" href="css/styles.css">

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ===== ADAPTACI√ìN SOLO TAMA√ëO M√ìVIL ===== -->
  <style>
  @media (max-width: 768px){

    .header-brand{
      flex-direction: column;
      gap: 14px;
      padding: 18px;
      text-align:center;
    }

    .brand{
      flex-direction: column;
      gap: 8px;
    }

    .brand img{
      height: 70px;
    }

    .brand h2{
      font-size: 20px;
    }

    header button{
      width: 100%;
      margin-left: 0;
    }

    .search-bar{
      width: 92%;
    }

    .search-bar input{
      height: 46px;
      font-size: 15px;
    }

    .historial-container{
      width: 94%;
    }

    .cliente{
      padding: 16px;
    }

    .cliente-header{
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }

    .cliente h3{
      font-size: 20px;
    }

    .acciones{
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .acciones button{
      width: 100%;
      font-size: 15px;
      padding: 14px;
    }

    .confirmacion .box{
      width: 92%;
      padding: 36px 20px;
    }

    .confirmacion h1{
      font-size: 28px;
    }

    .confirmacion p{
      font-size: 16px;
    }

    .confirmacion button{
      width: 100%;
      margin-top: 10px;
    }

  }
  </style>
</head>

<body>

<header class="header-brand">
  <div class="brand">
    <img src="img/logo.png">
    <h2>Clientes</h2>
  </div>
  <button onclick="location.href='index.html'">‚Üê Inicio</button>
</header>

<div class="search-bar">
  <input id="busqueda" placeholder="Buscar cliente...">
</div>

<div class="historial-container" id="listaClientes"></div>

<div class="confirmacion error" id="confirmBorrar">
  <div class="box">
    <h1>Eliminar cliente</h1>
    <p>Esta acci√≥n no se puede revertir</p>
    <button id="btnConfirmarBorrado">Confirmar</button>
    <button id="btnCancelarBorrado">Cancelar</button>
  </div>
</div>

<div class="confirmacion" id="confirmReasignar">
  <div class="box">
    <h1>Reasignar tarjeta</h1>
    <p>Acerque la nueva tarjeta</p>
    <div id="estadoTarjeta" class="estado amarillo">Esperando tarjeta‚Ä¶</div>
    <button id="btnCancelarReasignar">Cancelar</button>
  </div>
</div>

<script src="js/storage.js"></script>
<script src="js/auth.js"></script>
<script src="js/nfc.js"></script>
<script src="js/realtime.js"></script>

<script>

function obtenerClientes() {
  return safeGet("clientes");
}

const listaClientes = document.getElementById("listaClientes");
const busqueda = document.getElementById("busqueda");
const confirmBorrar = document.getElementById("confirmBorrar");
const confirmReasignar = document.getElementById("confirmReasignar");
const estadoTarjeta = document.getElementById("estadoTarjeta");

const btnConfirmarBorrado = document.getElementById("btnConfirmarBorrado");
const btnCancelarBorrado = document.getElementById("btnCancelarBorrado");
const btnCancelarReasignar = document.getElementById("btnCancelarReasignar");

let clientes = [];
let clienteIdEliminar = null;
let clienteIdReasignar = null;
let leyendoTarjeta = false;

window.addEventListener("load", () => {
  if (!verificarSesion()) return;

  busqueda.oninput = filtrar;
  btnConfirmarBorrado.onclick = confirmarBorrado;
  btnCancelarBorrado.onclick = cancelarBorrado;
  btnCancelarReasignar.onclick = cancelarReasignacion;

  iniciarSyncClientes();
  cargarClientes();
});

function iniciarSyncClientes() {
  const bc = new BroadcastChannel("victory-data");

  bc.onmessage = e => {
    if (e.data === "clientes") cargarClientes();
  };

  window.addEventListener("storage", e => {
    if (e.key === "clientes") cargarClientes();
  });
}

function cargarClientes() {
  clientes = obtenerClientes()
    .filter(c => c && typeof c.nombre === "string")
    .sort((a,b)=>a.nombre.localeCompare(b.nombre));

  render(clientes);
}

function render(lista) {
  listaClientes.innerHTML = "";

  if (!lista.length) {
    listaClientes.innerHTML = "<p>No hay clientes registrados</p>";
    return;
  }

  lista.forEach(c => {

    const cont = document.createElement("div");
    cont.className = "cliente";

    cont.innerHTML = `
      <div class="cliente-header">
        <h3>${c.nombre}</h3>
        <div class="acciones">
          <button onclick="iniciarReasignacion('${c.id}')">
            Reasignar tarjeta
          </button>
          <button onclick="pedirConfirmacion('${c.id}')">
            Eliminar
          </button>
        </div>
      </div>
    `;

    listaClientes.appendChild(cont);

  });
}

function filtrar() {
  const q = busqueda.value.toLowerCase();
  render(clientes.filter(c => c.nombre.toLowerCase().includes(q)));
}

/* üîß SOLO ESTA FUNCI√ìN FUE CORREGIDA */

function pedirConfirmacion(id) {
  clienteIdEliminar = id;
  confirmBorrar.style.display = "flex";
}

function cancelarBorrado() {
  clienteIdEliminar = null;
  confirmBorrar.style.display = "none";
}

async function confirmarBorrado() {

  if (!clienteIdEliminar) return;

  const listaLocal = obtenerClientes();
  const cliente = listaLocal.find(c => c.id === clienteIdEliminar);

  if (!cliente) return;

  if (navigator.onLine && window.borrarClienteSupabase) {
    await borrarClienteSupabase(cliente.id);
  }

  const nuevaLista = listaLocal.filter(
    c => c.id !== cliente.id
  );

  safeSet("clientes", nuevaLista);
  new BroadcastChannel("victory-data").postMessage("clientes");

  cancelarBorrado();
  cargarClientes();
}

/* REASIGNACI√ìN INTACTA */
function iniciarReasignacion(uid) {
  clienteUIDReasignar = uid;
  leyendoTarjeta = false;
  estadoTarjeta.className = "estado amarillo";
  estadoTarjeta.textContent = "Esperando tarjeta‚Ä¶";
  confirmReasignar.style.display = "flex";

  iniciarNFCControlado({
    onUID: async uidNuevo => {
      if (leyendoTarjeta) return;
      leyendoTarjeta = true;

      let clienteActualizado = null;
      const uidViejo = clienteUIDReasignar;

      const lista = obtenerClientes().map(c => {
        if (c.tarjetaUID === uidViejo) {
          c.tarjetaUID = uidNuevo;
          clienteActualizado = c;
        }
        return c;
      });

      safeSet("clientes", lista);
      new BroadcastChannel("victory-data").postMessage("clientes");

      if (clienteActualizado && typeof actualizarClienteSupabase === "function") {
        await actualizarClienteSupabase(clienteActualizado);
      }

      if (typeof migrarUIDEnAttendance === "function") {
        await migrarUIDEnAttendance(uidViejo, uidNuevo);
      }

      estadoTarjeta.className = "estado verde";
      estadoTarjeta.textContent = "Tarjeta reasignada";

      setTimeout(() => {
        cancelarReasignacion();
        cargarClientes();
      }, 1200);
    }
  });
}

function cancelarReasignacion() {
  clienteUIDReasignar = null;
  leyendoTarjeta = false;
  detenerNFC();
  confirmReasignar.style.display = "none";
}

</script>

</body>
</html>
