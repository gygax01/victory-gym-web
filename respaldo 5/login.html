<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Login - Victory Pro Fitness</title>
  <link rel="stylesheet" href="css/styles.css">

  <!-- Supabase SOLO para nfc.js -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="centered login-bg">

<div class="card login-card">
  <div class="login-logo">
    <img src="img/logo.png" alt="Victory Pro Fitness">
  </div>

  <input id="inputUser" placeholder="Usuario">
  <input id="inputPass" type="password" placeholder="Contrase√±a">

  <button class="btn-login" id="btnLogin">Ingresar</button>
  <hr>
  <button class="nfc btn-nfc" id="btnNFC">Ingresar con tarjeta</button>

  <button class="btn-sec" onclick="location.href='usuarios.html?modo=registro'">
    Registrar usuario
  </button>

  <p class="small muted" id="estadoConexion">Comprobando conexi√≥n‚Ä¶</p>
</div>

<!-- ===== LOADER ===== -->
<div class="overlay" id="overlayLoader" style="display:none">
  <div class="popup">
    <h2>Ingresando</h2>
    <div id="estadoLoader" class="estado amarillo">Accediendo‚Ä¶</div>
  </div>
</div>

<!-- ===== NFC ===== -->
<div class="overlay" id="overlayNFC" style="display:none">
  <div class="popup">
    <h2>Acerque la tarjeta</h2>
    <div id="estadoNFC" class="estado amarillo">Esperando tarjeta‚Ä¶</div>
  </div>
</div>

<!-- ===== ERRORES ===== -->
<div class="overlay" id="overlayUsuario" style="display:none">
  <div class="popup">
    <h2>Usuario no encontrado</h2>
    <div class="estado rojo">El usuario ingresado no existe</div>
  </div>
</div>

<div class="overlay" id="overlayPassword" style="display:none">
  <div class="popup">
    <h2>Error de acceso</h2>
    <div class="estado rojo">La contrase√±a es incorrecta</div>
  </div>
</div>

<!-- ===== JS BASE ===== -->
<script src="js/storage.js"></script>
<script src="js/auth.js"></script>
<script src="js/nfc.js"></script>
<script src="js/realtime.js"></script>


<script>
/* ===============================
   ===== DOM =====
=============================== */
const btnLogin = document.getElementById("btnLogin");
const btnNFC = document.getElementById("btnNFC");
const inputUser = document.getElementById("inputUser");
const inputPass = document.getElementById("inputPass");

const overlayLoader = document.getElementById("overlayLoader");
const estadoLoader = document.getElementById("estadoLoader");

const overlayUsuario = document.getElementById("overlayUsuario");
const overlayPassword = document.getElementById("overlayPassword");

const overlayNFC = document.getElementById("overlayNFC");
const estadoNFC = document.getElementById("estadoNFC");

const estadoConexion = document.getElementById("estadoConexion");

/* ===============================
   ===== ESTADO =====
=============================== */
let leyendoNFC = false;
let timeoutNFC = null;

/* ===============================
   ===== INIT =====
=============================== */
window.addEventListener("load", () => {
  // üîí si ya hay sesi√≥n activa, no permitir login
  if (obtenerSesion()) {
    location.href = "index.html";
    return;
  }

  actualizarEstadoConexion();
});

/* ===============================
   ===== CONEXI√ìN =====
=============================== */
function actualizarEstadoConexion() {
  if (navigator.onLine) {
    estadoConexion.textContent = "Conectado";
    estadoConexion.style.color = "#2ecc71";
  } else {
    estadoConexion.textContent = "Modo sin conexi√≥n";
    estadoConexion.style.color = "#f1c40f";
  }
}

window.addEventListener("online", actualizarEstadoConexion);
window.addEventListener("offline", actualizarEstadoConexion);

/* ===============================
   ===== HELPERS =====
=============================== */
function ocultarOverlays() {
  document.querySelectorAll(".overlay").forEach(o => o.style.display = "none");
}

/* ===============================
   ===== LOGIN NORMAL =====
=============================== */
btnLogin.onclick = () => {
  ocultarOverlays();

  const r = login(inputUser.value.trim(), inputPass.value, 0);

  if (r === "NO_USER") {
    overlayUsuario.style.display = "flex";
    setTimeout(ocultarOverlays, 1500);
    return;
  }

  if (r === "BAD_PASS") {
    overlayPassword.style.display = "flex";
    setTimeout(ocultarOverlays, 1500);
    return;
  }

  if (r === "OK") {
    overlayLoader.style.display = "flex";
    estadoLoader.className = "estado amarillo";
    estadoLoader.textContent = "Accediendo‚Ä¶";

    setTimeout(() => {
      estadoLoader.className = "estado verde";
      estadoLoader.textContent = "Acceso correcto";
    }, 400);
  }
};

/* ===============================
   ===== LOGIN NFC =====
=============================== */
btnNFC.onclick = () => {
  if (leyendoNFC) return;
  leyendoNFC = true;

  ocultarOverlays();

  overlayNFC.style.display = "flex";
  estadoNFC.className = "estado amarillo";
  estadoNFC.textContent = "Esperando tarjeta‚Ä¶";

  timeoutNFC = setTimeout(() => {
    estadoNFC.className = "estado rojo";
    estadoNFC.textContent = "Tiempo excedido para lectura";
    setTimeout(resetNFC, 1500);
  }, 10000);

  iniciarNFCControlado({
    onUID: uid => {
      clearTimeout(timeoutNFC);

      const emp = obtenerEmpleados().find(e => e.tarjetaUID === uid);
      if (!emp) {
        estadoNFC.className = "estado rojo";
        estadoNFC.textContent = "Tarjeta no registrada";
        setTimeout(resetNFC, 1500);
        return;
      }

      estadoNFC.className = "estado verde";
      estadoNFC.textContent = "Acceso correcto";

      setTimeout(() => {
        resetNFC();
        overlayLoader.style.display = "flex";
        estadoLoader.className = "estado verde";
        estadoLoader.textContent = "Acceso correcto";
        login(emp.usuario, emp.password, 0);
      }, 700);
    }
  });
};

function resetNFC() {
  clearTimeout(timeoutNFC);
  detenerNFC();
  leyendoNFC = false;
  ocultarOverlays();
}
</script>

</body>
</html>

