
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Login - Victory Pro Fitness</title>
  <link rel="stylesheet" href="css/styles.css">

  <!-- Supabase (requerido por nfc.js) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="centered login-bg">

<div class="card login-card">
  <div class="login-logo">
    <img src="img/logo.png" alt="Victory Pro Fitness">
  </div>

  <input id="inputUser" placeholder="Usuario" autocomplete="username">
  <input id="inputPass" type="password" placeholder="Contraseña" autocomplete="current-password">

  <button class="btn-login" id="btnLogin">Ingresar</button>

  <hr>

  <button class="nfc btn-nfc" id="btnNFC">
    Ingresar con tarjeta
  </button>

  <button class="btn-sec"
          onclick="location.href='usuarios.html?modo=registro'">
    Registrar usuario
  </button>

  <p class="small muted">Acceso exclusivo para personal autorizado</p>
</div>

<!-- ===== POPUP NFC ===== -->
<div class="overlay" id="overlay" style="display:none">
  <div class="popup">
    <h2>Acerque la tarjeta</h2>
    <div id="estadoNFC" class="estado amarillo">Esperando tarjeta…</div>
  </div>
</div>

<!-- ===== JS BASE (ORDEN IMPORTANTE) ===== -->
<script src="js/storage.js"></script>
<script src="js/auth.js"></script>
<script src="js/nfc.js"></script>

<script>
/* ===============================
   ===== DOM =====
=============================== */
const inputUser = document.getElementById("inputUser");
const inputPass = document.getElementById("inputPass");
const btnLogin = document.getElementById("btnLogin");
const btnNFC = document.getElementById("btnNFC");
const overlay = document.getElementById("overlay");
const estadoNFC = document.getElementById("estadoNFC");

/* ===============================
   ===== BOOTSTRAP SUPERADMIN =====
=============================== */
(function crearSuperAdminSiNoExiste() {
  const emps = obtenerEmpleados();
  if (emps.some(e => e.rol === "superadmin")) return;

  emps.push({
    nombre: "Sistema",
    usuario: "gygax",
    password: "admin(1234)",
    rol: "superadmin",
    hidden: true,
    protected: true
  });

  guardarEmpleados(emps);
})();

/* ===============================
   ===== ESTADO =====
=============================== */
let leyendoNFC = false;

/* ===============================
   ===== INIT =====
=============================== */
window.addEventListener("load", () => {
  btnLogin.addEventListener("click", loginManual);
  btnNFC.addEventListener("click", loginConTarjeta);

  // Enter para login
  inputPass.addEventListener("keydown", e => {
    if (e.key === "Enter") loginManual();
  });
});

/* ===============================
   ===== LOGIN MANUAL =====
=============================== */
function loginManual() {
  if (leyendoNFC) return;

  const user = inputUser.value.trim();
  const pass = inputPass.value;

  if (!user || !pass) return;

  login(user, pass, 2200);
}

/* ===============================
   ===== LOGIN NFC =====
=============================== */
function loginConTarjeta() {
  if (leyendoNFC) return;

  leyendoNFC = true;
  btnNFC.disabled = true;

  overlay.style.display = "flex";
  estadoNFC.className = "estado amarillo";
  estadoNFC.textContent = "Esperando tarjeta…";

  iniciarNFCControlado({
    onUID: uid => {
      const emp = obtenerEmpleados().find(e => e.tarjetaUID === uid);

      if (!emp) {
        estadoNFC.className = "estado rojo";
        estadoNFC.textContent = "Tarjeta no registrada";
        setTimeout(resetNFC, 1500);
        return;
      }

      estadoNFC.className = "estado verde";
      estadoNFC.textContent = "Acceso correcto";

      setTimeout(() => {
        resetNFC();
        login(emp.usuario, emp.password, 0);
      }, 800);
    },

    onTimeout: () => {
      estadoNFC.className = "estado rojo";
      estadoNFC.textContent = "Tiempo de lectura agotado";
      setTimeout(resetNFC, 1500);
    },

    onError: () => {
      estadoNFC.className = "estado rojo";
      estadoNFC.textContent = "Error de lectura";
      setTimeout(resetNFC, 1500);
    }
  });
}

/* ===============================
   ===== RESET NFC =====
=============================== */
function resetNFC() {
  detenerNFC();
  leyendoNFC = false;
  btnNFC.disabled = false;
  overlay.style.display = "none";
}
</script>

</body>
</html>
