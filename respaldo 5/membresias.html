<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Membresías</title>
<link rel="stylesheet" href="css/styles.css">
</head>

<body>
<header class="header-brand">
  <div class="brand"><img src="img/logo.png"><h2>Membresías</h2></div>
  <button onclick="location.href='index.html'">← Inicio</button>
</header>

<div class="historial-container" id="listaMembresias"></div>

<script src="js/storage.js"></script>
<script src="js/auth.js"></script>

<script>
const listaMembresias=document.getElementById("listaMembresias");

window.addEventListener("load",initMembresias);
function initMembresias(){
  if(!verificarSesion())return;
  if(!requirePermission("memberships_view"))return;
  cargarMembresias();
  applyPermissions();
}

function cargarMembresias(){
  const clientes=obtenerClientes().filter(c=>c&&typeof c.nombre==="string");
  listaMembresias.innerHTML="";
  if(!clientes.length){listaMembresias.textContent="No hay clientes registrados";return;}
  clientes.forEach((c,i)=>{
    const card=document.createElement("div");card.className="cliente";
    card.innerHTML=`
      <h3>${c.nombre}</h3>
      <p>Expira: ${c.membresiaExpira ?? "—"}</p>
      <button data-permission="memberships_extend">+7 días</button>
      <button data-permission="memberships_extend">+30 días</button>`;
    const btns=card.querySelectorAll("button");
    btns[0].onclick=()=>extenderMembresia(i,7);
    btns[1].onclick=()=>extenderMembresia(i,30);
    listaMembresias.appendChild(card);
  });
  applyPermissions();
}

function extenderMembresia(i,dias){
  if(!can("memberships_extend"))return;
  const clientes=obtenerClientes();
  const c=clientes[i]; if(!c)return;
  const base=new Date(c.membresiaExpira||hoy());
  base.setDate(base.getDate()+dias);
  c.membresiaExpira=base.toISOString().split("T")[0];
  guardarClientes(clientes);
  cargarMembresias();
}
</script>
</body>
</html>
