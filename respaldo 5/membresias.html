<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Membres√≠as</title>
<link rel="stylesheet" href="css/styles.css">

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
@media (max-width: 768px){
  .header-brand{
    flex-direction: column;
    gap: 14px;
    padding: 18px;
    text-align:center;
  }
  .brand{
    flex-direction: column;
    gap: 8px;
  }
  .brand img{
    height: 70px;
  }
  .brand h2{
    font-size: 20px;
  }
  header button{
    width: 100%;
    margin-left: 0;
  }
  .historial-container{
    width: 94%;
  }
  .cliente{
    padding: 16px;
  }
  .cliente h3{
    font-size: 20px;
  }
  .cliente p{
    font-size: 14px;
  }
  .cliente button{
    width: 100%;
    margin-top: 10px;
    padding: 14px;
    font-size: 15px;
  }
}
</style>
</head>

<body>

<header class="header-brand">
  <div class="brand">
    <img src="img/logo.png">
    <h2>Membres√≠as</h2>
  </div>
  <button onclick="location.href='index.html'">‚Üê Inicio</button>
</header>

<div class="historial-container" id="listaMembresias"></div>

<!-- JS BASE (NO TOCAR) -->
<script src="js/storage.js"></script>
<script src="js/auth.js"></script>
<script src="js/realtime.js"></script>

<script>

/* =====================================================
   ================= VARIABLES DOM ======================
===================================================== */
const listaMembresias = document.getElementById("listaMembresias");

/* =====================================================
   ================= INIT PRINCIPAL =====================
   Se ejecuta cuando carga la p√°gina
===================================================== */
window.addEventListener("load", initMembresias);

async function initMembresias() {

  // üîê Validar sesi√≥n
  if (!verificarSesion()) return;

  // üî• Siempre intentar traer datos reales primero
  await sincronizarDesdeSupabase();

  // üé® Pintar tarjetas
  renderMembresias();

  // üîÑ Activar sincronizaci√≥n entre pesta√±as
  activarSyncLocal();

  // üî¥ Activar realtime si existe
  if (navigator.onLine && typeof iniciarRealtime === "function") {
    iniciarRealtime();
  }
}

/* =====================================================
   =========== SINCRONIZAR DESDE SUPABASE ==============
   Trae clientes reales y actualiza cache local
===================================================== */
async function sincronizarDesdeSupabase() {

  if (!navigator.onLine || !window.supabaseClient) return;

  const { data, error } = await supabaseClient
    .from("clientes")
    .select("*")
    .order("created_at", { ascending: true });

  if (error) {
    console.error("Error cargando clientes:", error);
    return;
  }

  // Guardamos copia local para cache
  safeSet("clientes", data || []);
}

/* =====================================================
   ================== RENDER UI =========================
===================================================== */
function renderMembresias() {

  const clientes = (safeGet("clientes") || [])
    .filter(c => c && typeof c.nombre === "string");

  listaMembresias.innerHTML = "";

  if (!clientes.length) {
    listaMembresias.textContent = "No hay clientes registrados";
    return;
  }

  clientes.forEach(cliente => {

    const card = document.createElement("div");
    card.className = "cliente";

    card.innerHTML = `
      <h3>${cliente.nombre}</h3>
      <p>Expira: ${cliente.membresia_expira ?? "‚Äî"}</p>
      <button>+7 d√≠as</button>
      <button>+30 d√≠as</button>
    `;

    const botones = card.querySelectorAll("button");

    botones[0].onclick = () => extenderMembresia(cliente.id, 7);
    botones[1].onclick = () => extenderMembresia(cliente.id, 30);

    listaMembresias.appendChild(card);
  });
}

/* =====================================================
   ============ EXTENDER MEMBRES√çA ======================
   Supabase-first real
===================================================== */
async function extenderMembresia(idCliente, dias) {

  if (!navigator.onLine) {
    alert("Sin conexi√≥n a internet");
    return;
  }

  // üîé Obtener fecha actual real desde Supabase
  const { data, error: fetchError } = await supabaseClient
    .from("clientes")
    .select("membresia_expira")
    .eq("id", idCliente)
    .single();

  if (fetchError) {
    console.error("Error obteniendo cliente:", fetchError);
    return;
  }

  // üìÖ Calcular nueva fecha
  const base = new Date(data.membresia_expira || new Date());
  base.setDate(base.getDate() + dias);

  const nuevaFecha = base.toISOString().split("T")[0];

  // üî• Actualizar en Supabase
  const { error } = await supabaseClient
    .from("clientes")
    .update({ membresia_expira: nuevaFecha })
    .eq("id", idCliente);

  if (error) {
    console.error("Error actualizando membres√≠a:", error);
    return;
  }

  // üîÑ Volver a sincronizar
  await sincronizarDesdeSupabase();

  // üîÑ Refrescar UI
  renderMembresias();

  // üîÑ Avisar a otras pesta√±as
  new BroadcastChannel("victory-data").postMessage("clientes");
}

/* =====================================================
   ============== SINCRONIZACI√ìN LOCAL ==================
===================================================== */
function activarSyncLocal() {

  const bc = new BroadcastChannel("victory-data");

  bc.onmessage = async e => {
    if (e.data === "clientes") {
      await sincronizarDesdeSupabase();
      renderMembresias();
    }
  };

  window.addEventListener("online", async () => {
    await sincronizarDesdeSupabase();
    renderMembresias();
  });
}

</script>

</body>
</html>
