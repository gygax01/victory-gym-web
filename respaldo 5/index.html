<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Inicio - Victory Pro Fitness</title>
  <link rel="stylesheet" href="css/styles.css">

  <!-- Supabase SOLO para nfc.js -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<!-- ===== HEADER BRANDING ===== -->
<header class="header-brand">
  <div class="brand">
    <img src="img/logo.png" alt="Victory Pro Fitness">
    <h2>Asistencias del día</h2>
  </div>

  <div class="estado-sistema">
    <span id="contadorAforo" class="contador">
      Dentro: <strong>0</strong>
    </span>

    <span id="estadoLector" class="lector off">
      Lector inactivo
    </span>

    <button id="btnLogout">Salir</button>
  </div>
</header>

<!-- ===== PANEL DE ACCIONES ===== -->
<div class="panel-acciones">
  <button class="destacado" onclick="location.href='registro.html'">Registro</button>
  <button onclick="location.href='pos.html'">Ventas</button>
  <button onclick="location.href='stock.html'">Stock</button>
  <button onclick="location.href='membresias.html'">Membresías</button>
  <button onclick="location.href='clientes.html'">Clientes</button>
  <button onclick="location.href='historial.html'">Historial</button>

  <button id="btnUsuarios" style="display:none"
          onclick="location.href='usuarios.html'">
    Usuarios
  </button>
</div>

<!-- ===== TABLA ASISTENCIAS ===== -->
<div id="contenedorTabla" style="max-height:70vh; overflow-y:auto;">
  <table>
    <thead>
      <tr>
        <th>Cliente</th>
        <th>Entrada</th>
        <th>Salida</th>
      </tr>
    </thead>
    <tbody id="tablaAsistencias"></tbody>
  </table>
</div>

<!-- ===== CONFIRMACIÓN ===== -->
<div class="confirmacion" id="confirmacion">
  <div class="box">
    <h1 id="tituloConfirmacion"></h1>
    <p id="mensajeConfirmacion"></p>
  </div>
</div>

<!-- ===== JS BASE (ORDEN IMPORTANTE) ===== -->
<script src="js/storage.js"></script>
<script src="js/auth.js"></script>
<script src="js/asistencias.js"></script>
<script src="js/nfc.js"></script>

<script>
/* ===============================
   ===== DOM =====
=============================== */
const estadoLector = document.getElementById("estadoLector");
const contenedorTabla = document.getElementById("contenedorTabla");
const confirmacion = document.getElementById("confirmacion");
const tituloConfirmacion = document.getElementById("tituloConfirmacion");
const mensajeConfirmacion = document.getElementById("mensajeConfirmacion");
const btnUsuarios = document.getElementById("btnUsuarios");
const btnLogout = document.getElementById("btnLogout");

/* ===============================
   ===== INIT =====
=============================== */
window.addEventListener("load", initIndex);

function initIndex() {
  if (!verificarSesion()) return;

  aplicarRolIndex();
  btnLogout.addEventListener("click", logout);

  cargarAsistencias();
  actualizarContador();
  iniciarLecturaNFCIndex();
}

/* ===============================
   ===== CONTROL DE ROL =====
=============================== */
function aplicarRolIndex() {
  const s = obtenerSesion();
  if (!s) return;

  if (s.rol === "admin" || s.rol === "superadmin") {
    btnUsuarios.style.display = "inline-block";
  }
}

/* ===============================
   ===== SONIDOS =====
=============================== */
const sonidoCorrecto = new Audio("sounds/correct.mp3");
const sonidoError = new Audio("sounds/error.mp3");

document.addEventListener("click", () => {
  sonidoCorrecto.play()
    .then(() => {
      sonidoCorrecto.pause();
      sonidoCorrecto.currentTime = 0;
    })
    .catch(() => {});
}, { once: true });

function playCorrecto() {
  sonidoCorrecto.currentTime = 0;
  sonidoCorrecto.play().catch(()=>{});
}

function playError() {
  sonidoError.currentTime = 0;
  sonidoError.play().catch(()=>{});
}

/* ===============================
   ===== AUTO SCROLL =====
=============================== */
function autoScrollTabla() {
  contenedorTabla.scrollTo({
    top: contenedorTabla.scrollHeight,
    behavior: "smooth"
  });
}

/* ===============================
   ===== NFC (ÚNICO PUNTO) =====
=============================== */
function iniciarLecturaNFCIndex() {
  estadoLector.className = "lector on";
  estadoLector.textContent = "Lector activo";

  iniciarNFCControlado({
    onUID: uid => {
      console.log("UID recibido:", uid);
      procesarTarjeta(uid);
    },
    onTimeout: () => {
      estadoLector.className = "lector off";
      estadoLector.textContent = "Lector inactivo";
      iniciarLecturaNFCIndex();
    },
    onError: () => {
      estadoLector.className = "lector off";
      estadoLector.textContent = "Error lector";
      setTimeout(iniciarLecturaNFCIndex, 2000);
    }
  });
}

/* ===============================
   ===== CONFIRMACIÓN =====
=============================== */
function mostrarConfirmacion(tipo, titulo, mensaje) {
  confirmacion.className = "confirmacion " + tipo;
  tituloConfirmacion.textContent = titulo;
  mensajeConfirmacion.textContent = mensaje;
  confirmacion.style.display = "flex";

  setTimeout(() => {
    confirmacion.style.display = "none";
  }, 2200);
}

/* ===============================
   ===== ENTRADA / SALIDA =====
=============================== */
function procesarTarjeta(uid) {
  if (buscarEmpleadoPorTarjeta(uid)) {
    mostrarConfirmacion("error", "Tarjeta de personal", "Use el login");
    playError();
    return;
  }

  const cliente = obtenerClientes().find(c => c.tarjetaUID === uid);
  if (!cliente) {
    mostrarConfirmacion("error", "Tarjeta no registrada", "Consulte recepción");
    playError();
    return;
  }

  const hoyFecha = hoy();
  const asistencias = obtenerAsistencias();

  const abierta = asistencias.find(a =>
    a.tarjetaUID === uid &&
    a.fecha === hoyFecha &&
    a.salida === null
  );

  if (!abierta) {
    asistencias.push({
      tarjetaUID: uid,
      nombre: cliente.nombre,
      entrada: horaActual(),
      salida: null,
      fecha: hoyFecha
    });
    mostrarConfirmacion("entrada", "Bienvenido", cliente.nombre);
    playCorrecto();
  } else {
    abierta.salida = horaActual();
    mostrarConfirmacion("salida", "Hasta luego", cliente.nombre);
    playCorrecto();
  }

  guardarAsistencias(asistencias);
  cargarAsistencias();
  actualizarContador();
  autoScrollTabla();
}
</script>

</body>
</html>
