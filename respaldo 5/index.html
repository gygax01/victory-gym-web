<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Inicio - Victory Pro Fitness</title>
  <link rel="stylesheet" href="css/styles.css">

  <!-- Supabase SOLO para realtime / nfc -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<header class="header-brand">
  <div class="brand">
    <img src="img/logo.png" alt="Victory Pro Fitness">
    <h2>Asistencias del día</h2>
  </div>

  <div class="estado-sistema">
    <span id="contadorAforo" class="contador">
      Dentro: <strong>0</strong>
    </span>

    <span id="estadoLector" class="lector off">Lector inactivo</span>
    <span id="estadoConexion" class="lector off">Offline</span>

    <button id="btnLogout">Salir</button>
  </div>
</header>

<div class="panel-acciones">
  <button class="destacado" onclick="location.href='registro.html'">Registro</button>
  <button onclick="location.href='pos.html'">Ventas</button>
  <button onclick="location.href='stock.html'">Stock</button>
  <button onclick="location.href='membresias.html'">Membresías</button>
  <button onclick="location.href='clientes.html'">Clientes</button>
  <button onclick="location.href='historial.html'">Historial</button>

  <button id="btnUsuarios" style="display:none"
          onclick="location.href='usuarios.html'">
    Usuarios
  </button>
</div>

<div id="contenedorTabla" style="max-height:70vh; overflow-y:auto;">
  <table>
    <thead>
      <tr>
        <th>Cliente</th>
        <th>Entrada</th>
        <th>Salida</th>
      </tr>
    </thead>
    <tbody id="tablaAsistencias"></tbody>
  </table>
</div>

<div class="confirmacion" id="confirmacion">
  <div class="box">
    <h1 id="tituloConfirmacion"></h1>
    <p id="mensajeConfirmacion"></p>
  </div>
</div>

<!-- ===== JS BASE ===== -->
<script src="js/storage.js"></script>
<script src="js/auth.js"></script>
<script src="js/asistencias.js"></script>
<script src="js/realtime.js"></script>
<script src="js/nfc.js"></script>
<script src="js/bluetooth.js"></script>

<script>
/* ================= ALIAS SESIÓN ================= */
function obtenerSesion() {
  return getSession();
}

/* ================= FIXES CRÍTICOS ================= */
/* asistencias.js espera estas funciones */

function obtenerAsistencias() {
  return safeGet("asistencias");
}

function syncOfflineQueue() {
  // Stub seguro: evita que el flujo se rompa
}

/* ================= DOM ================= */
const estadoLector = document.getElementById("estadoLector");
const estadoConexion = document.getElementById("estadoConexion");
const btnUsuarios = document.getElementById("btnUsuarios");
const btnLogout = document.getElementById("btnLogout");

/* ================= INIT ================= */
window.addEventListener("load", initIndex);

function initIndex() {
  if (!verificarSesion()) return;

  aplicarRolIndex();
  btnLogout.onclick = logout;

  actualizarEstadoConexion();
  cargarAsistencias();
  actualizarContador();

  iniciarLecturaNFCIndex();
  iniciarSyncLocal();

  if (navigator.onLine && typeof iniciarRealtime === "function") {
    iniciarRealtime();
  }

  if (!navigator.onLine) {
    conectarBluetooth().catch(() => {});
  }
}

/* ================= ROLES ================= */
function aplicarRolIndex() {
  const s = obtenerSesion();
  if (s && (s.rol === "admin" || s.rol === "superadmin")) {
    btnUsuarios.style.display = "inline-block";
  }
}

/* ================= CONEXIÓN ================= */
function actualizarEstadoConexion() {
  if (navigator.onLine) {
    estadoConexion.textContent = "Online";
    estadoConexion.className = "lector on";
    syncOfflineQueue();
  } else {
    estadoConexion.textContent = "Offline";
    estadoConexion.className = "lector off";
  }
}

window.addEventListener("online", () => {
  actualizarEstadoConexion();
  if (typeof iniciarRealtime === "function") iniciarRealtime();
});
window.addEventListener("offline", actualizarEstadoConexion);

/* ================= SYNC LOCAL ================= */
function iniciarSyncLocal() {
  const bc = new BroadcastChannel("victory-data");

  bc.onmessage = e => {
    if (e.data === "asistencias") {
      cargarAsistencias();
      actualizarContador();
    }
  };

  window.addEventListener("storage", e => {
    if (e.key === "asistencias") {
      cargarAsistencias();
      actualizarContador();
    }
  });
}

/* ================= NFC ================= */
function iniciarLecturaNFCIndex() {
  estadoLector.className = "lector on";
  estadoLector.textContent = "Lector activo";

  iniciarNFCControlado({
    onUID: uid => procesarTarjeta(uid),
    onTimeout: iniciarLecturaNFCIndex,
    onError: () => setTimeout(iniciarLecturaNFCIndex, 2000)
  });
}

/* ================= CONFIRM ================= */
function mostrarConfirmacion(tipo, titulo, mensaje) {
  const confirmacion = document.getElementById("confirmacion");
  const tituloConfirmacion = document.getElementById("tituloConfirmacion");
  const mensajeConfirmacion = document.getElementById("mensajeConfirmacion");

  confirmacion.className = "confirmacion " + tipo;
  tituloConfirmacion.textContent = titulo;
  mensajeConfirmacion.textContent = mensaje;
  confirmacion.style.display = "flex";

  setTimeout(() => confirmacion.style.display = "none", 2200);
}

/* ================= ENTRADA / SALIDA ================= */
function procesarTarjeta(uid) {
  if (buscarEmpleadoPorTarjeta(uid)) {
    mostrarConfirmacion("error", "Tarjeta de personal", "Use el login");
    return;
  }

  const cliente = obtenerClientes().find(c => c.tarjetaUID === uid);
  if (!cliente) {
    mostrarConfirmacion("error", "Tarjeta no registrada", "Consulte recepción");
    return;
  }

  const asistencias = obtenerAsistencias();
  const fechaHoy = hoy();

  const delDia = asistencias
    .filter(a => a.tarjetaUID === uid && a.fecha === fechaHoy)
    .sort((a,b)=>a.entrada.localeCompare(b.entrada));

  const ultima = delDia[delDia.length - 1] || null;

  if (!ultima || ultima.salida !== null) {
    const nueva = {
      id: crypto.randomUUID(),
      tarjetaUID: uid,
      nombre: cliente.nombre,
      entrada: horaActual(),
      salida: null,
      fecha: fechaHoy
    };

    registrarAsistencia(nueva);
    subirEntradaSupabase(nueva);
    mostrarConfirmacion("entrada","Bienvenido",cliente.nombre);

  } else {
    ultima.salida = horaActual();
    safeSet("asistencias", asistencias);
    subirSalidaSupabase(ultima);
    mostrarConfirmacion("salida","Hasta luego",cliente.nombre);
  }

  notificarCambioAsistencias();
  cargarAsistencias();
  actualizarContador();
}

/* ================= SUPABASE ASISTENCIAS ================= */
async function subirEntradaSupabase(a) {
  if (!window.supabaseClient || !navigator.onLine) return;

  await supabaseClient.from("asistencias").insert({
    id: a.id,
    tarjeta_uid: a.tarjetaUID,
    nombre: a.nombre,
    entrada: a.entrada,
    salida: null,
    fecha: a.fecha
  });
}

async function subirSalidaSupabase(a) {
  if (!window.supabaseClient || !navigator.onLine) return;

  await supabaseClient
    .from("asistencias")
    .update({ salida: a.salida })
    .eq("tarjeta_uid", a.tarjetaUID)
    .eq("fecha", a.fecha)
    .is("salida", null);
}
</script>

</body>
</html>
