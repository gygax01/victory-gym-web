<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Inicio - Victory Pro Fitness</title>
  <link rel="stylesheet" href="css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<header class="header-brand">
  <div class="brand">
    <img src="img/logo.png">
    <h2>Asistencias del día</h2>
  </div>

  <div class="estado-sistema">
    <span id="contadorAforo" class="contador">
      Dentro: <strong>0</strong>
    </span>

    <span id="estadoLector" class="lector off">Lector inactivo</span>
    <span id="estadoConexion" class="lector off">Offline</span>

    <button id="btnLogout">Salir</button>
  </div>
</header>

<div class="panel-acciones">
  <button class="destacado" onclick="location.href='registro.html'">Registro</button>
  <button onclick="location.href='pos.html'">Ventas</button>
  <button onclick="location.href='stock.html'">Stock</button>
  <button onclick="location.href='membresias.html'">Membresías</button>
  <button onclick="location.href='clientes.html'">Clientes</button>
  <button onclick="location.href='historial.html'">Historial</button>
  <button id="btnUsuarios" style="display:none" onclick="location.href='usuarios.html'">
    Usuarios
  </button>
</div>

<div id="contenedorTabla" style="max-height:70vh; overflow-y:auto;">
  <table>
    <thead>
      <tr>
        <th>Cliente</th>
        <th>Entrada</th>
        <th>Salida</th>
      </tr>
    </thead>
    <tbody id="tablaAsistencias"></tbody>
  </table>
</div>

<div class="confirmacion" id="confirmacion">
  <div class="box">
    <h1 id="tituloConfirmacion"></h1>
    <p id="mensajeConfirmacion"></p>
  </div>
</div>

<script src="js/storage.js"></script>
<script src="js/auth.js"></script>
<script src="js/asistencias.js"></script>
<script src="js/realtime.js"></script>
<script src="js/nfc.js"></script>
<script src="js/bluetooth.js"></script>

<script>

function obtenerClientes() { return safeGet("clientes"); }
function obtenerAsistencias() { return safeGet("asistencias"); }

window.addEventListener("load", () => {

  const estadoLector = document.getElementById("estadoLector");
  const estadoConexion = document.getElementById("estadoConexion");
  const btnUsuarios = document.getElementById("btnUsuarios");
  const btnLogout = document.getElementById("btnLogout");

  if (typeof verificarSesion === "function") {
    if (!verificarSesion()) return;
  }

  const s = typeof getSession === "function" ? getSession() : null;

  if (s && (s.rol === "admin" || s.rol === "superadmin")) {
    btnUsuarios.style.display = "inline-block";
  }

  btnLogout.onclick = logout;

  actualizarEstadoConexion(estadoConexion);
  cargarAsistencias();
  actualizarContador();
  iniciarLecturaNFCIndex(estadoLector);
});

function actualizarEstadoConexion(el) {
  if (!el) return;

  if (navigator.onLine) {
    el.textContent = "Online";
    el.className = "lector on";
  } else {
    el.textContent = "Offline";
    el.className = "lector off";
  }
}

function mostrarConfirmacion(tipo, titulo, mensaje) {
  const box = document.getElementById("confirmacion");
  document.getElementById("tituloConfirmacion").textContent = titulo;
  document.getElementById("mensajeConfirmacion").textContent = mensaje;

  box.className = "confirmacion " + tipo;
  box.style.display = "flex";
  setTimeout(() => box.style.display = "none", 2200);
}

function iniciarLecturaNFCIndex(estadoLector) {

  if (!estadoLector) return;

  estadoLector.className = "lector on";
  estadoLector.textContent = "Lector activo";

  if (typeof iniciarNFCControlado === "function") {
    iniciarNFCControlado({
      onUID: procesarTarjeta,
      onTimeout: () => iniciarLecturaNFCIndex(estadoLector),
      onError: () => setTimeout(() => iniciarLecturaNFCIndex(estadoLector), 2000)
    });
  }
}

function procesarTarjeta(uid) {

  const cliente = obtenerClientes().find(c => c.tarjetaUID === uid);

  if (!cliente) {
    mostrarConfirmacion("error", "Tarjeta no registrada", "Consulte recepción");
    return;
  }

  const asistencias = obtenerAsistencias();
  const fechaHoy = hoy();
  const ahoraTS = Date.now();

  const abierta = [...asistencias].reverse().find(a =>
    a.tarjetaUID === uid &&
    a.fecha === fechaHoy &&
    a.salida_ts === null
  );

  if (!abierta) {

    const nueva = {
      id: crypto.randomUUID(),
      tarjetaUID: uid,
      nombre: cliente.nombre,
      fecha: fechaHoy,
      entrada_ts: ahoraTS,
      salida_ts: null
    };

    asistencias.push(nueva);
    safeSet("asistencias", asistencias);

    await supabaseClient.from("asistencias").insert({
      tarjeta_uid: uid,
      nombre: cliente.nombre,
      fecha: fechaHoy,
      entrada_ts: new Date(ahoraTS).toISOString(),
      salida_ts: null
    });

    mostrarConfirmacion("entrada", "Bienvenido", cliente.nombre);

  } else {

    abierta.salida_ts = ahoraTS;
    safeSet("asistencias", asistencias);

    await supabaseClient
      .from("asistencias")
      .update({ salida_ts: new Date(ahoraTS).toISOString() })
      .eq("tarjeta_uid", uid)
      .eq("fecha", fechaHoy)
      .is("salida_ts", null);

    mostrarConfirmacion("salida", "Hasta luego", cliente.nombre);
  }

  notificarCambioAsistencias();
  cargarAsistencias();
  actualizarContador();
}

</script>

</body>
</html>
