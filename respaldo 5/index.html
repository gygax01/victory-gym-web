<script>

/* ================= ALIAS ================= */

function obtenerClientes() { return safeGet("clientes"); }
function obtenerAsistencias() { return safeGet("asistencias"); }
function guardarAsistencias(data) { safeSet("asistencias", data); }

/* ================= DOM ================= */

const estadoLector = document.getElementById("estadoLector");
const estadoConexion = document.getElementById("estadoConexion");
const btnUsuarios = document.getElementById("btnUsuarios");
const btnLogout = document.getElementById("btnLogout");

/* ================= INIT ================= */

window.addEventListener("load", () => {

  if (!verificarSesion()) return;

  const s = getSession();
  if (s && (s.rol === "admin" || s.rol === "superadmin")) {
    btnUsuarios.style.display = "inline-block";
  }

  btnLogout.onclick = logout;

  actualizarEstadoConexion();
  cargarAsistencias();
  actualizarContador();

  iniciarLecturaNFCIndex();
});

/* ================= CONEXIÓN ================= */

function actualizarEstadoConexion() {
  if (navigator.onLine) {
    estadoConexion.textContent = "Online";
    estadoConexion.className = "lector on";
  } else {
    estadoConexion.textContent = "Offline";
    estadoConexion.className = "lector off";
  }
}

/* ================= CONFIRMACIÓN ================= */

function mostrarConfirmacion(tipo, titulo, mensaje) {

  const box = document.getElementById("confirmacion");

  document.getElementById("tituloConfirmacion").textContent = titulo;
  document.getElementById("mensajeConfirmacion").textContent = mensaje;

  box.className = "confirmacion " + tipo;
  box.style.display = "flex";

  setTimeout(() => box.style.display = "none", 2200);
}

/* ================= NFC ================= */

function iniciarLecturaNFCIndex() {

  estadoLector.className = "lector on";
  estadoLector.textContent = "Lector activo";

  iniciarNFCControlado({
    onUID: procesarTarjeta,
    onTimeout: iniciarLecturaNFCIndex,
    onError: () => setTimeout(iniciarLecturaNFCIndex, 2000)
  });
}

/* ======================================================
   ===== ENTRADA / SALIDA (BLINDADO DEFINITIVO) =========
====================================================== */

function procesarTarjeta(uid) {

  const cliente = obtenerClientes().find(c => c.tarjetaUID === uid);

  if (!cliente) {
    mostrarConfirmacion("error", "Tarjeta no registrada", "Consulte recepción");
    return;
  }

  const asistencias = obtenerAsistencias();
  const fechaHoy = hoy();
  const ahoraTS = Date.now();

  /* ===== BUSCAR ABIERTAS DEL DÍA ===== */

  const abiertasHoy = asistencias.filter(a =>
    a.tarjetaUID === uid &&
    a.fecha === fechaHoy &&
    typeof a.entrada_ts === "number" &&
    !a.salida_ts
  );

  /* ===== AUTOCORRECCIÓN SI HAY MÁS DE UNA ===== */

  if (abiertasHoy.length > 1) {

    abiertasHoy
      .sort((a, b) => b.entrada_ts - a.entrada_ts)
      .slice(1)
      .forEach(a => {
        a.salida_ts = ahoraTS;
      });
  }

  const abierta = abiertasHoy
    .sort((a, b) => b.entrada_ts - a.entrada_ts)[0];

  /* ===== SI NO HAY ABIERTA → ENTRADA ===== */

  if (!abierta) {

    const nueva = {
      id: crypto.randomUUID(),
      tarjetaUID: uid,
      nombre: cliente.nombre,
      fecha: fechaHoy,
      entrada_ts: ahoraTS,
      salida_ts: null
    };

    asistencias.push(nueva);

    guardarAsistencias(asistencias);

    subirEntradaSupabase(nueva);

    mostrarConfirmacion("entrada", "Bienvenido", cliente.nombre);

  }
  /* ===== SI HAY ABIERTA → SALIDA ===== */
  else {

    abierta.salida_ts = ahoraTS;

    guardarAsistencias(asistencias);

    subirSalidaSupabase(abierta);

    mostrarConfirmacion("salida", "Hasta luego", cliente.nombre);
  }

  notificarCambioAsistencias();
  cargarAsistencias();
  actualizarContador();
}

/* ================= SUPABASE ================= */

async function subirEntradaSupabase(a) {

  if (!window.supabaseClient || !navigator.onLine) return;

  await supabaseClient.from("asistencias").insert({
    id: a.id,
    tarjeta_uid: a.tarjetaUID,
    nombre: a.nombre,
    fecha: a.fecha,
    entrada_ts: a.entrada_ts,
    salida_ts: null
  });
}

async function subirSalidaSupabase(a) {

  if (!window.supabaseClient || !navigator.onLine) return;

  await supabaseClient
    .from("asistencias")
    .update({ salida_ts: a.salida_ts })
    .eq("id", a.id);
}

</script>
