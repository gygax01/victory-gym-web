<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Historial</title>
<link rel="stylesheet" href="css/styles.css">

<!-- ===== ADAPTACI√ìN SOLO TAMA√ëO M√ìVIL ===== -->
<style>
@media (max-width: 768px){

  .header-brand{
    flex-direction: column;
    gap: 14px;
    padding: 18px;
    text-align:center;
  }

  .brand{
    flex-direction: column;
    gap: 8px;
  }

  .brand img{
    height: 70px;
  }

  .brand h2{
    font-size: 20px;
  }

  header button{
    width: 100%;
    margin-left: 0;
  }

  .search-bar{
    width: 92%;
  }

  .search-bar input{
    height: 46px;
    font-size: 15px;
  }

  .historial-container{
    width: 94%;
  }

  .cliente{
    padding: 16px;
  }

  .cliente h3{
    font-size: 20px;
  }

  .meta{
    font-size: 13px;
  }

  .flecha{
    font-size: 20px;
  }

  .historial{
    overflow-x: auto;
  }

  .historial table{
    font-size: 13px;
  }

  .historial th,
  .historial td{
    padding: 8px 6px;
  }

}
</style>
</head>

<body>

<header class="header-brand">
  <div class="brand">
    <img src="img/logo.png" alt="Victory Pro Fitness">
    <h2>Historial de clientes</h2>
  </div>
  <button onclick="location.href='index.html'">‚Üê Inicio</button>
</header>

<div class="search-bar">
  <input id="busqueda" placeholder="Buscar cliente...">
</div>

<div class="historial-container" id="listaHistorial"></div>

<!-- ===== JS BASE ===== -->
<script src="js/storage.js"></script>
<script src="js/auth.js"></script>

<!-- ‚úÖ SUPABASE (ESTO FALTABA) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- CREA window.supabaseClient -->
<script src="js/realtime.js"></script>

<script>
/* ================= ALIAS CR√çTICOS ================= */
function obtenerClientes() {
  return safeGet("clientes");
}

function obtenerAsistencias() {
  return safeGet("asistencias");
}

/* ================= DOM ================= */
const listaHistorial = document.getElementById("listaHistorial");
const busqueda = document.getElementById("busqueda");

/* ================= ESTADO ================= */
let clientes = [];
let asistencias = [];

/* ================= INIT ================= */
window.addEventListener("load", initHistorial);

async function initHistorial() {
  if (!verificarSesion()) return;

  busqueda.addEventListener("input", filtrar);

  let cargado = false;

  if (navigator.onLine && window.supabaseClient) {
    cargado = await cargarAsistenciasDesdeSupabase();
  }

  // üî• Si Supabase fall√≥, usar cache local
  if (!cargado) {
    console.warn("‚ö†Ô∏è Usando datos locales");
  }

  cargarHistorial();
  iniciarSyncHistorial();
}


/* ================= SUPABASE ‚Üí ASISTENCIAS ================= */
async function cargarAsistenciasDesdeSupabase() {
  const { data, error } = await supabaseClient
    .from("attendance")
    .select("*")
    .order("fecha", { ascending: false });

  if (error) {
    console.error("‚ùå Error cargando asistencias:", error);
    return false;
  }

  const normalizadas = (data || []).map(a => ({
    id: a.id,
    tarjetaUID: a.uid, // üëà aqu√≠ cambia seg√∫n tu columna real
    nombre: a.nombre,
    fecha: a.fecha,
    entrada_ts: a.entrada_ts ?? null,
    salida_ts: a.salida_ts ?? null,
    entrada: a.entrada ?? null,
    salida: a.salida ?? null
  }));

  safeSet("asistencias", normalizadas);

  return true;
}
/* ================= SINCRONIZACI√ìN ================= */
function iniciarSyncHistorial() {
  const bc = new BroadcastChannel("victory-data");

  bc.onmessage = e => {
    if (["asistencias", "clientes"].includes(e.data)) {
      cargarHistorial();
    }
  };

  window.addEventListener("storage", e => {
    if (["asistencias", "clientes"].includes(e.key)) {
      cargarHistorial();
    }
  });
}

/* ================= UTILIDADES ================= */
function diasEntre(a, b) {
  return Math.round((new Date(b) - new Date(a)) / 86400000);
}

function ultimaVisita(uid) {
  return asistencias
    .filter(a => a.tarjetaUID === uid)
    .map(a => a.fecha)
    .sort()
    .reverse()[0] ?? "‚Äî";
}

function calcularRachas(uid) {
  const fechas = [...new Set(
    asistencias.filter(a => a.tarjetaUID === uid).map(a => a.fecha)
  )].sort();

  let max = 0, actual = 0, temp = fechas.length ? 1 : 0;

  for (let i = 1; i < fechas.length; i++) {
    if (diasEntre(fechas[i - 1], fechas[i]) === 1) temp++;
    else { max = Math.max(max, temp); temp = 1; }
  }
  max = Math.max(max, temp);

  for (let i = fechas.length - 1; i > 0; i--) {
    if (diasEntre(fechas[i - 1], fechas[i]) === 1) actual++;
    else break;
  }
  actual = fechas.length ? actual + 1 : 0;

  return { actual, max };
}

function horaLocalDesdeTS(ts) {
  if (!ts) return "-";
  return new Date(ts).toLocaleTimeString([], {
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit"
  });
}

/* ================= CARGA ================= */
function cargarHistorial() {
  clientes = obtenerClientes().filter(c => c && typeof c.nombre === "string");
  asistencias = obtenerAsistencias();

  clientes.sort((a, b) =>
    ultimaVisita(b.tarjetaUID)
      .localeCompare(ultimaVisita(a.tarjetaUID))
  );

  render(clientes);
}

/* ================= RENDER ================= */
function render(lista) {
  listaHistorial.innerHTML = "";

  if (!lista.length) {
    listaHistorial.innerHTML = "<p>No hay historial disponible</p>";
    return;
  }

  lista.forEach(c => {
    const registros = asistencias
      .filter(a => a.tarjetaUID === c.tarjetaUID)
      .sort((a, b) => b.fecha.localeCompare(a.fecha));

    const { actual, max } = calcularRachas(c.tarjetaUID);

    const card = document.createElement("div");
    card.className = "cliente";

    card.innerHTML = `
      <div class="cliente-header" aria-expanded="false">
        <div class="info-wrapper">
          <div class="info-bloque">
            <h3>${c.nombre}</h3>
            <div class="meta">
              <span class="racha actual">Racha actual: ${actual} d√≠as</span>
              &nbsp; ¬∑ &nbsp;
              <span class="racha maxima">Racha m√°xima: ${max} d√≠as</span>
            </div>
          </div>
        </div>
        <div class="flecha">‚ñæ</div>
      </div>

      <div class="historial">
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Entrada</th>
              <th>Salida</th>
            </tr>
          </thead>
          <tbody>
            ${
              registros.map((r, i) => `
                <tr class="${i % 2 ? 'alt' : ''}">
                  <td>${r.fecha}</td>
                  <td>${r.entrada_ts ? horaLocalDesdeTS(r.entrada_ts) : (r.entrada ?? "-")}</td>
                  <td>${r.salida_ts ? horaLocalDesdeTS(r.salida_ts) : (r.salida ?? "-")}</td>
                </tr>
              `).join("")
            }
          </tbody>
        </table>
      </div>
    `;

    const header = card.querySelector(".cliente-header");
    const panel = card.querySelector(".historial");

    header.onclick = () => {
      document.querySelectorAll(".cliente.abierto").forEach(o => {
        if (o !== card) {
          o.classList.remove("abierto");
          o.querySelector(".historial")?.classList.remove("abierto");
        }
      });

      const abierto = card.classList.toggle("abierto");
      panel.classList.toggle("abierto");
      header.setAttribute("aria-expanded", abierto);
    };

    listaHistorial.appendChild(card);
  });
}

/* ================= FILTRO ================= */
function filtrar() {
  const q = busqueda.value.toLowerCase();
  render(clientes.filter(c =>
    c.nombre.toLowerCase().includes(q)
  ));
}
</script>

</body>
</html>




