<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Historial</title>
  <link rel="stylesheet" href="css/styles.css">
</head>

<body onload="verificarSesion(); cargarHistorial();">

<header class="header-brand">
  <div class="brand">
    <img src="img/logo.png" alt="Victory Pro Fitness">
    <h2>Historial de clientes</h2>
  </div>

  <button class="btn-volver" onclick="location.href='index.html'">← Inicio</button>
</header>

<div class="search-bar">
  <input id="busqueda" placeholder="Buscar cliente..." oninput="filtrar()">
</div>

<div class="historial-container" id="listaHistorial"></div>

<script src="js/storage.js"></script>
<script src="js/auth.js"></script>

<script>
let clientes = [];
let asistencias = [];

function diasEntre(a, b) {
  return Math.round((new Date(b) - new Date(a)) / 86400000);
}

function ultimaVisita(uid) {
  return asistencias
    .filter(a => a.tarjetaUID === uid)
    .map(a => a.fecha)
    .sort()
    .reverse()[0] ?? null;
}

function calcularRachas(uid) {
  const fechas = [...new Set(
    asistencias.filter(a => a.tarjetaUID === uid).map(a => a.fecha)
  )].sort();

  let max = 0, actual = 0, temp = 1;

  for (let i = 1; i < fechas.length; i++) {
    if (diasEntre(fechas[i - 1], fechas[i]) === 1) temp++;
    else { max = Math.max(max, temp); temp = 1; }
  }
  max = Math.max(max, temp);

  for (let i = fechas.length - 1; i > 0; i--) {
    if (diasEntre(fechas[i - 1], fechas[i]) === 1) actual++;
    else break;
  }
  actual = fechas.length ? actual + 1 : 0;

  return { actual, max };
}

function cargarHistorial() {
  clientes = obtenerClientes();
  asistencias = obtenerAsistencias();

  clientes.sort((a, b) =>
    (ultimaVisita(b.tarjetaUID) ?? "")
      .localeCompare(ultimaVisita(a.tarjetaUID) ?? "")
  );

  render(clientes);
}

function render(lista) {
  const cont = document.getElementById("listaHistorial");
  cont.innerHTML = "";

  lista.forEach(c => {
    const registros = asistencias
      .filter(a => a.tarjetaUID === c.tarjetaUID)
      .sort((a, b) => b.fecha.localeCompare(a.fecha));

    const ultima = ultimaVisita(c.tarjetaUID);
    const registro = c.fechaRegistro ?? "—";
    const { actual, max } = calcularRachas(c.tarjetaUID);

    const card = document.createElement("div");
    card.className = "cliente";

    card.innerHTML = `
      <div class="cliente-header" aria-expanded="false">
        <div class="info-wrapper">
          <div class="info-bloque">
            <h3>${c.nombre}</h3>
            <div class="meta">
              Última visita: ${ultima} · Registro: ${registro}<br>
              <span class="racha actual">Racha actual: ${actual} días</span>
              &nbsp; · &nbsp;
              <span class="racha maxima">Racha máxima: ${max} días</span>

            </div>
          </div>
        </div>
        <div class="flecha">▾</div>
      </div>

      <div class="historial">
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Entrada</th>
              <th>Salida</th>
            </tr>
          </thead>
          <tbody>
            ${
              registros.map((r, i) => `
                <tr class="${i % 2 ? 'alt' : ''}">
                  <td>${r.fecha}</td>
                  <td>${r.entrada}</td>
                  <td>${r.salida ?? "-"}</td>
                </tr>
              `).join("")
            }
          </tbody>
        </table>
      </div>
    `;

    const header = card.querySelector(".cliente-header");
    const panel = card.querySelector(".historial");

    header.onclick = () => {
      document.querySelectorAll(".cliente.abierto").forEach(o => {
        if (o !== card) {
          o.classList.remove("abierto");
          o.querySelector(".historial")?.classList.remove("abierto");
          o.querySelector(".cliente-header")
            ?.setAttribute("aria-expanded", "false");
        }
      });

      const abierto = card.classList.toggle("abierto");
      panel.classList.toggle("abierto");
      header.setAttribute("aria-expanded", abierto);
    };

    cont.appendChild(card);
  });
}
</script>

</body>
</html>
