
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Historial</title>
  <link rel="stylesheet" href="css/styles.css">
</head>

<body>

<header class="header-brand">
  <div class="brand">
    <img src="img/logo.png" alt="Victory Pro Fitness">
    <h2>Historial de clientes</h2>
  </div>

  <button class="btn-volver" onclick="location.href='index.html'">← Inicio</button>
</header>

<div class="search-bar">
  <input id="busqueda" placeholder="Buscar cliente...">
</div>

<div class="historial-container" id="listaHistorial"></div>

<!-- ===== JS BASE (ORDEN IMPORTANTE) ===== -->
<script src="js/storage.js"></script>
<script src="js/auth.js"></script>

<script>
/* ===============================
   ===== DOM =====
=============================== */
const listaHistorial = document.getElementById("listaHistorial");
const busqueda = document.getElementById("busqueda");

/* ===============================
   ===== ESTADO =====
=============================== */
let clientes = [];
let asistencias = [];

/* ===============================
   ===== INIT =====
=============================== */
window.addEventListener("load", initHistorial);

function initHistorial() {
  if (!verificarSesion()) return;
  if (typeof requirePermission === "function") {
    requirePermission("history_view");
  }

  busqueda.addEventListener("input", filtrar);
  cargarHistorial();
}

/* ===============================
   ===== UTIL =====
=============================== */
function diasEntre(a, b) {
  return Math.round(
    (new Date(b) - new Date(a)) / 86400000
  );
}

function ultimaVisita(uid) {
  return asistencias
    .filter(a => a.tarjetaUID === uid)
    .map(a => a.fecha)
    .sort()
    .reverse()[0] ?? null;
}

/* ===============================
   ===== RACHAS =====
=============================== */
function calcularRachas(uid) {
  const fechas = [...new Set(
    asistencias
      .filter(a => a.tarjetaUID === uid)
      .map(a => a.fecha)
  )].sort();

  let max = 0;
  let temp = fechas.length ? 1 : 0;

  for (let i = 1; i < fechas.length; i++) {
    if (diasEntre(fechas[i - 1], fechas[i]) === 1) {
      temp++;
    } else {
      max = Math.max(max, temp);
      temp = 1;
    }
  }
  max = Math.max(max, temp);

  let actual = 0;
  for (let i = fechas.length - 1; i > 0; i--) {
    if (diasEntre(fechas[i - 1], fechas[i]) === 1) actual++;
    else break;
  }
  actual = fechas.length ? actual + 1 : 0;

  return { actual, max };
}

/* ===============================
   ===== CARGAR =====
=============================== */
function cargarHistorial() {
  clientes = obtenerClientes().filter(
    c => c && typeof c.nombre === "string"
  );
  asistencias = obtenerAsistencias();

  clientes.sort((a, b) =>
    (ultimaVisita(b.tarjetaUID) ?? "")
      .localeCompare(ultimaVisita(a.tarjetaUID) ?? "")
  );

  render(clientes);
}

/* ===============================
   ===== RENDER =====
=============================== */
function render(lista) {
  listaHistorial.innerHTML = "";

  if (lista.length === 0) {
    const p = document.createElement("p");
    p.textContent = "No hay historial disponible";
    listaHistorial.appendChild(p);
    return;
  }

  lista.forEach(c => {
    const registros = asistencias
      .filter(a => a.tarjetaUID === c.tarjetaUID)
      .sort((a, b) => b.fecha.localeCompare(a.fecha));

    const ultima = ultimaVisita(c.tarjetaUID) ?? "—";
    const registro = c.fechaRegistro ?? "—";
    const { actual, max } = calcularRachas(c.tarjetaUID);

    const card = document.createElement("div");
    card.className = "cliente";

    const header = document.createElement("div");
    header.className = "cliente-header";
    header.setAttribute("aria-expanded", "false");

    const info = document.createElement("div");
    info.className = "info-wrapper";

    const bloque = document.createElement("div");
    bloque.className = "info-bloque";

    const nombre = document.createElement("h3");
    nombre.textContent = c.nombre;

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.innerHTML = `
      Última visita: ${ultima} · Registro: ${registro}<br>
      <span class="racha actual">Racha actual: ${actual} días</span>
      &nbsp; · &nbsp;
      <span class="racha maxima">Racha máxima: ${max} días</span>
    `;

    const flecha = document.createElement("div");
    flecha.className = "flecha";
    flecha.textContent = "▾";

    bloque.append(nombre, meta);
    info.appendChild(bloque);
    header.append(info, flecha);

    const panel = document.createElement("div");
    panel.className = "historial";

    const table = document.createElement("table");

    const thead = document.createElement("thead");
    thead.innerHTML = `
      <tr>
        <th>Fecha</th>
        <th>Entrada</th>
        <th>Salida</th>
      </tr>
    `;

    const tbody = document.createElement("tbody");

    registros.forEach((r, i) => {
      const tr = document.createElement("tr");
      if (i % 2) tr.className = "alt";

      const tdFecha = document.createElement("td");
      tdFecha.textContent = r.fecha;

      const tdEntrada = document.createElement("td");
      tdEntrada.textContent = r.entrada;

      const tdSalida = document.createElement("td");
      tdSalida.textContent = r.salida ?? "-";

      tr.append(tdFecha, tdEntrada, tdSalida);
      tbody.appendChild(tr);
    });

    table.append(thead, tbody);
    panel.appendChild(table);

    header.onclick = () => {
      document.querySelectorAll(".cliente.abierto").forEach(o => {
        if (o !== card) {
          o.classList.remove("abierto");
          o.querySelector(".historial")?.classList.remove("abierto");
          o.querySelector(".cliente-header")
            ?.setAttribute("aria-expanded", "false");
        }
      });

      const abierto = card.classList.toggle("abierto");
      panel.classList.toggle("abierto");
      header.setAttribute("aria-expanded", abierto);
    };

    card.append(header, panel);
    listaHistorial.appendChild(card);
  });
}

/* ===============================
   ===== FILTRO =====
=============================== */
function filtrar() {
  const q = busqueda.value.toLowerCase();
  render(clientes.filter(c =>
    c.nombre.toLowerCase().includes(q)
  ));
}
</script>

</body>
</html>
