<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Historial</title>
<link rel="stylesheet" href="css/styles.css">
<style>
  .debug-box {
    background:#111;
    color:#0f0;
    padding:10px;
    font-size:12px;
    margin:10px;
    border-radius:6px;
    font-family: monospace;
  }
</style>
</head>

<body>

<header class="header-brand">
  <div class="brand">
    <img src="img/logo.png" alt="Victory Pro Fitness">
    <h2>Historial de clientes</h2>
  </div>
  <button onclick="location.href='index.html'">‚Üê Inicio</button>
</header>

<!-- DEBUG VISIBLE -->
<div id="debug" class="debug-box">
  Iniciando‚Ä¶
</div>

<div class="search-bar">
  <input id="busqueda" placeholder="Buscar cliente...">
</div>

<div class="historial-container" id="listaHistorial"></div>

<!-- ===== JS BASE ===== -->
<script src="js/storage.js"></script>
<script src="js/auth.js"></script>

<!-- CREA window.supabaseClient -->
<script src="js/realtime.js"></script>

<script>
/* ================= ALIAS ================= */
function obtenerClientes() {
  return safeGet("clientes");
}
function obtenerAsistencias() {
  return safeGet("asistencias");
}

/* ================= DOM ================= */
const listaHistorial = document.getElementById("listaHistorial");
const busqueda = document.getElementById("busqueda");
const debug = document.getElementById("debug");

/* ================= ESTADO ================= */
let clientes = [];
let asistencias = [];

/* ================= INIT ================= */
window.addEventListener("load", initHistorial);

async function initHistorial() {
  debug.textContent = "Init‚Ä¶";

  if (!verificarSesion()) {
    debug.textContent = "‚ùå Sin sesi√≥n";
    return;
  }

  if (!can("history_view")) {
    debug.textContent = "‚ùå Sin permiso history_view";
    return;
  }

  busqueda.addEventListener("input", filtrar);

  if (navigator.onLine && window.supabaseClient) {
    await cargarAsistenciasDesdeSupabase();
  } else {
    debug.textContent += "\n‚ö†Ô∏è Offline o sin Supabase";
  }

  iniciarSyncHistorial();
  cargarHistorial();
}

/* ================= SUPABASE ================= */
async function cargarAsistenciasDesdeSupabase() {
  debug.textContent = "üì° Consultando Supabase‚Ä¶";

  const { data, error } = await supabaseClient
    .from("asistencias")
    .select("*");

  if (error) {
    debug.textContent += "\n‚ùå Error Supabase";
    return;
  }

  debug.textContent += `\n‚úÖ Supabase registros: ${data.length}`;

  asistencias = (data || []).map(a => ({
    id: a.id,
    tarjetaUID: a.tarjeta_uid,
    nombre: a.nombre,
    fecha: a.fecha,
    entrada_ts: a.entrada_ts ?? null,
    salida_ts: a.salida_ts ?? null,
    entrada: a.entrada ?? null,
    salida: a.salida ?? null
  }));

  safeSet("asistencias", asistencias);
  debug.textContent += `\nüíæ Guardados en localStorage: ${asistencias.length}`;
}

/* ================= SYNC ================= */
function iniciarSyncHistorial() {
  const bc = new BroadcastChannel("victory-data");

  bc.onmessage = e => {
    if (["asistencias","clientes"].includes(e.data)) {
      cargarHistorial();
    }
  };

  window.addEventListener("storage", e => {
    if (["asistencias","clientes"].includes(e.key)) {
      cargarHistorial();
    }
  });
}

/* ================= UTIL ================= */
function diasEntre(a, b) {
  return Math.round((new Date(b) - new Date(a)) / 86400000);
}

function ultimaVisita(uid) {
  return asistencias
    .filter(a => a.tarjetaUID === uid)
    .map(a => a.fecha)
    .sort()
    .reverse()[0] ?? "‚Äî";
}

function calcularRachas(uid) {
  const fechas = [...new Set(
    asistencias.filter(a => a.tarjetaUID === uid).map(a => a.fecha)
  )].sort();

  let max = 0, actual = 0, temp = fechas.length ? 1 : 0;

  for (let i = 1; i < fechas.length; i++) {
    if (diasEntre(fechas[i - 1], fechas[i]) === 1) temp++;
    else { max = Math.max(max, temp); temp = 1; }
  }
  max = Math.max(max, temp);

  for (let i = fechas.length - 1; i > 0; i--) {
    if (diasEntre(fechas[i - 1], fechas[i]) === 1) actual++;
    else break;
  }
  actual = fechas.length ? actual + 1 : 0;

  return { actual, max };
}

function horaLocal(ts) {
  if (!ts) return "-";
  return new Date(ts).toLocaleTimeString();
}

/* ================= CARGA ================= */
function cargarHistorial() {
  clientes = obtenerClientes();
  asistencias = obtenerAsistencias();

  debug.textContent += `\nüë• Clientes: ${clientes.length}`;
  debug.textContent += `\nüìä Asistencias en memoria: ${asistencias.length}`;

  render(clientes);
}

/* ================= RENDER ================= */
function render(lista) {
  listaHistorial.innerHTML = "";

  if (!lista.length) {
    listaHistorial.innerHTML = "<p>No hay historial disponible</p>";
    return;
  }

  lista.forEach(c => {
    const registros = asistencias.filter(a => a.tarjetaUID === c.tarjetaUID);

    const card = document.createElement("div");
    card.className = "cliente";

    card.innerHTML = `
      <div class="cliente-header">
        <h3>${c.nombre}</h3>
      </div>
      <div class="historial">
        <table>
          <thead><tr><th>Fecha</th><th>Entrada</th><th>Salida</th></tr></thead>
          <tbody>
            ${
              registros.map(r => `
                <tr>
                  <td>${r.fecha}</td>
                  <td>${r.entrada_ts ? horaLocal(r.entrada_ts) : r.entrada}</td>
                  <td>${r.salida_ts ? horaLocal(r.salida_ts) : (r.salida ?? "-")}</td>
                </tr>
              `).join("")
            }
          </tbody>
        </table>
      </div>
    `;

    listaHistorial.appendChild(card);
  });
}

/* ================= FILTRO ================= */
function filtrar() {
  const q = busqueda.value.toLowerCase();
  render(clientes.filter(c => c.nombre.toLowerCase().includes(q)));
}
</script>

</body>
</html>
